const { token, ownerId } = require('./config.js');

const profileProcessing = new Map();
const commandCooldown = new Map();
const { Client, GatewayIntentBits, EmbedBuilder } = require('discord.js');
const fs = require('fs');

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,
    GatewayIntentBits.GuildPresences, // Äá»ƒ check online status
    GatewayIntentBits.GuildVoiceStates, // For voice state updates
    GatewayIntentBits.GuildMessageReactions, // For reaction collectors
  ],
});

const dataFile = './userData.json';

// Load user data
let userData = {};
if (fs.existsSync(dataFile)) {
  userData = JSON.parse(fs.readFileSync(dataFile, 'utf8'));
}

// Save user data
function saveData() {
  fs.writeFileSync(dataFile, JSON.stringify(userData, null, 2));
}

// Banking functions
function createBankingProfile(userId) {
  if (!userData[userId].banking) {
    userData[userId].banking = {
      balance: 0,
      transactions: [],
      createdAt: new Date().toISOString()
    };
    saveData();
  }
  return userData[userId].banking;
}

function addTransaction(userId, type, amount, description, targetId = null) {
  if (!userData[userId].banking) createBankingProfile(userId);
  
  const transaction = {
    id: `T${Date.now()}${Math.floor(Math.random() * 1000)}`,
    type: type, // 'deposit', 'withdraw', 'transfer_in', 'transfer_out'
    amount: amount,
    description: description,
    targetId: targetId,
    timestamp: new Date().toISOString()
  };

  userData[userId].banking.transactions.push(transaction);
  
  // Giá»›i háº¡n lá»‹ch sá»­ giao dá»‹ch chá»‰ lÆ°u 50 giao dá»‹ch gáº§n nháº¥t
  if (userData[userId].banking.transactions.length > 50) {
    userData[userId].banking.transactions = userData[userId].banking.transactions.slice(-50);
  }
  
  saveData();
  return transaction;
}

function formatTransactionHistory(transactions, userData) {
  let history = '';
  const recentTransactions = transactions.slice(-10).reverse(); // 10 giao dá»‹ch gáº§n nháº¥t
  
  for (const tx of recentTransactions) {
    const date = new Date(tx.timestamp).toLocaleString('vi-VN');
    let line = `[${date}] `;
    
    switch (tx.type) {
      case 'deposit':
        line += `ğŸ“¥ Náº¡p tiá»n: +${tx.amount.toLocaleString('vi-VN')} VND`;
        break;
      case 'withdraw':
        line += `ğŸ“¤ RÃºt tiá»n: -${tx.amount.toLocaleString('vi-VN')} VND`;
        break;
      case 'transfer_out':
        const targetName = tx.targetId ? `<@${tx.targetId}>` : 'Unknown';
        line += `ğŸ’¸ Chuyá»ƒn cho ${targetName}: -${tx.amount.toLocaleString('vi-VN')} VND`;
        break;
      case 'transfer_in':
        const senderName = tx.targetId ? `<@${tx.targetId}>` : 'Unknown';
        line += `ğŸ’° Nháº­n tá»« ${senderName}: +${tx.amount.toLocaleString('vi-VN')} VND`;
        break;
    }
    
    if (tx.description) line += `\nğŸ’¬ Ghi chÃº: ${tx.description}`;
    history += line + '\n\n';
  }
  
  return history || 'ChÆ°a cÃ³ giao dá»‹ch nÃ o.';
}

const lastMessageTime = new Map();

function getLevelInfo(xp) {
  let level = 1;
  let required = 0;
  while (xp >= required + (level * 100 + (level - 1) * 50)) {
    required += level * 100 + (level - 1) * 50;
    level++;
    if (level > 1000) break; // Cap at 1000
  }
  const nextRequired = level * 100 + (level - 1) * 50;
  const nextXp = nextRequired - (xp - required);
  return { level: Math.min(level, 1000), nextXp };
}

function checkLevelUp(user, message) {
  const { level: newLevel } = getLevelInfo(user.xp);
  if (newLevel > user.lastLevel) {
    if (newLevel % 5 === 0) {
      // Há»™p quÃ : 3 random items + tiá»n nhá»
      user.inventory = user.inventory || [];
      const receivedItems = [];
      for (let i = 0; i < 3; i++) {
        const item = getRandomItem();
        user.inventory.push(item);
        receivedItems.push(item.name);
      }
      user.money += 10000; // Tiá»n nhá»
      message.reply(`ğŸ‰ ChÃºc má»«ng lÃªn level ${newLevel}! Nháº­n há»™p quÃ : ${receivedItems.join(', ')} + 10,000 VND!`);
    } else {
      // ThÆ°á»Ÿng tiá»n ngáº«u nhiÃªn tÄƒng dáº§n
      const minReward = 20000 + (newLevel - 1) * 5000;
      const maxReward = 50000 + (newLevel - 1) * 10000;
      const levelReward = Math.floor(Math.random() * (maxReward - minReward + 1)) + minReward;
      user.money += levelReward;
      message.reply(`ğŸ‰ ChÃºc má»«ng lÃªn level ${newLevel}! ThÆ°á»Ÿng: +${levelReward.toLocaleString('vi-VN')} VND!`);
    }
    user.lastLevel = newLevel;
  }
}

// Items cÃ³ Ä‘á»™ hiáº¿m (dÃ nh cho há»™p quÃ , event,...)
const rareItems = {
  basic: [
    { id: 'B1', name: 'Ão thun limited', sellPrice: 5000 },
    { id: 'B2', name: 'Quáº§n jean rÃ¡ch', sellPrice: 10000 },
    { id: 'B3', name: 'GiÃ y thá»ƒ thao special', sellPrice: 15000 },
    { id: 'B4', name: 'Ão khoÃ¡c phiÃªn báº£n giá»›i háº¡n', sellPrice: 20000 },
  ],
  accessory: [
    { id: 'A1', name: 'VÃ²ng tay pha lÃª', sellPrice: 30000 },
    { id: 'A2', name: 'Nháº«n báº¡c Ä‘áº·c biá»‡t', sellPrice: 50000 },
    { id: 'A3', name: 'KÃ­nh rÃ¢m thá»i thÆ°á»£ng', sellPrice: 40000 },
    { id: 'A4', name: 'DÃ¢y chuyá»n kim cÆ°Æ¡ng', sellPrice: 45000 },
  ],
  ultra: [
    { id: 'U1', name: 'Set Ä‘á»“ cao cáº¥p', sellPrice: 100000 },
    { id: 'U2', name: 'MÅ© hiá»‡u á»©ng', sellPrice: 80000 },
    { id: 'U3', name: 'TÃºi xÃ¡ch branded', sellPrice: 120000 },
  ],
  ultra_rare: [
    { id: 'UR1', name: 'Set trang phá»¥c limited', sellPrice: 200000 },
    { id: 'UR2', name: 'Trang phá»¥c legendary', sellPrice: 250000 },
    { id: 'UR3', name: 'Set phá»¥ kiá»‡n quÃ½ phÃ¡i', sellPrice: 180000 },
  ],
  super_ultra_rare: [
    { id: 'SUR1', name: 'Trang phá»¥c tháº§n thoáº¡i', sellPrice: 5000000 },
    { id: 'SUR2', name: 'Set Ä‘á»“ huyá»n bÃ­', sellPrice: 6000000 },
    { id: 'SUR3', name: 'Phá»¥ kiá»‡n vÃ´ giÃ¡', sellPrice: 7000000 },
    { id: 'SUR4', name: 'Ão choÃ ng siÃªu cáº¥p', sellPrice: 8000000 },
  ],
  ssur: [
    { id: 'SSUR1', name: 'Set trang phá»¥c tá»‘i thÆ°á»£ng', sellPrice: 20000000 },
    { id: 'SSUR2', name: 'Trang phá»¥c tháº§n linh', sellPrice: 24000000 },
    { id: 'SSUR3', name: 'Set phá»¥ kiá»‡n huyá»n thoáº¡i', sellPrice: 28000000 },
    { id: 'SSUR4', name: 'Ão choÃ ng vÄ©nh cá»­u', sellPrice: 32000000 },
  ],
};

// Shop items (khÃ´ng cÃ³ Ä‘á»™ hiáº¿m)
// Shop items

const shopItems = {
  fashion: [
    // Äá»“ bÃ¬nh dÃ¢n (Chá»£ - CH)
    { id: 'FASHION_CH1', displayId: '#CH1', name: 'Ão thun chá»£', price: 50000, brand: 'Chá»£', type: 'Ão', tier: 'BÃ¬nh dÃ¢n' },
    { id: 'FASHION_CH2', displayId: '#CH2', name: 'Quáº§n jean chá»£', price: 100000, brand: 'Chá»£', type: 'Quáº§n', tier: 'BÃ¬nh dÃ¢n' },
    { id: 'FASHION_CH3', displayId: '#CH3', name: 'GiÃ y dÃ©p chá»£', price: 80000, brand: 'Chá»£', type: 'GiÃ y', tier: 'BÃ¬nh dÃ¢n' },
    
    // Local Brand bÃ¬nh dÃ¢n (Local - LB)
    { id: 'FASHION_LB1', displayId: '#LB1', name: 'Ão thun Yame', price: 200000, brand: 'Yame', type: 'Ão', tier: 'Local Brand' },
    { id: 'FASHION_LB2', displayId: '#LB2', name: 'Quáº§n jean Routine', price: 350000, brand: 'Routine', type: 'Quáº§n', tier: 'Local Brand' },
    { id: 'FASHION_LB3', displayId: '#LB3', name: 'GiÃ y Bitis Hunter', price: 500000, brand: 'Bitis', type: 'GiÃ y', tier: 'Local Brand' },

    // ThÆ°Æ¡ng hiá»‡u phá»• thÃ´ng (Basic - BS)
    { id: 'FASHION_BS1', displayId: '#BS1', name: 'Ão Uniqlo', price: 500000, brand: 'Uniqlo', type: 'Ão', tier: 'Phá»• thÃ´ng' },
    { id: 'FASHION_BS2', displayId: '#BS2', name: 'Quáº§n H&M', price: 800000, brand: 'H&M', type: 'Quáº§n', tier: 'Phá»• thÃ´ng' },
    { id: 'FASHION_BS3', displayId: '#BS3', name: 'GiÃ y Adidas Neo', price: 1200000, brand: 'Adidas', type: 'GiÃ y', tier: 'Phá»• thÃ´ng' },

    // ThÆ°Æ¡ng hiá»‡u cao cáº¥p (Premium - PR)
    { id: 'FASHION_PR1', displayId: '#PR1', name: 'Ão Polo Lacoste', price: 2500000, brand: 'Lacoste', type: 'Ão', tier: 'Cao cáº¥p' },
    { id: 'FASHION_PR2', displayId: '#PR2', name: 'Quáº§n Versace Jeans', price: 5000000, brand: 'Versace', type: 'Quáº§n', tier: 'Cao cáº¥p' },
    { id: 'FASHION_PR3', displayId: '#PR3', name: 'GiÃ y Nike Air Max', price: 4000000, brand: 'Nike', type: 'GiÃ y', tier: 'Cao cáº¥p' },

    // ThÆ°Æ¡ng hiá»‡u luxury (Luxury - LX)
    { id: 'FASHION_LX1', displayId: '#LX1', name: 'Ão Gucci Monogram', price: 15000000, brand: 'Gucci', type: 'Ão', tier: 'Luxury' },
    { id: 'FASHION_LX2', displayId: '#LX2', name: 'Quáº§n Louis Vuitton', price: 20000000, brand: 'Louis Vuitton', type: 'Quáº§n', tier: 'Luxury' },
    { id: 'FASHION_LX3', displayId: '#LX3', name: 'GiÃ y Balenciaga Triple S', price: 25000000, brand: 'Balenciaga', type: 'GiÃ y', tier: 'Luxury' },

    // Phá»¥ kiá»‡n bÃ¬nh dÃ¢n (Accessory Basic - AB)
    { id: 'FASHION_AB1', displayId: '#AB1', name: 'MÅ© lÆ°á»¡i trai local brand', price: 150000, brand: 'Local', type: 'Phá»¥ kiá»‡n', tier: 'BÃ¬nh dÃ¢n' },
    { id: 'FASHION_AB2', displayId: '#AB2', name: 'TÃºi Ä‘eo chÃ©o Bitis', price: 300000, brand: 'Bitis', type: 'Phá»¥ kiá»‡n', tier: 'BÃ¬nh dÃ¢n' },
    { id: 'FASHION_AB3', displayId: '#AB3', name: 'KÃ­nh mÃ¡t Uniqlo', price: 400000, brand: 'Uniqlo', type: 'Phá»¥ kiá»‡n', tier: 'BÃ¬nh dÃ¢n' },

    // Phá»¥ kiá»‡n cao cáº¥p (Accessory Premium - AP)
    { id: 'FASHION_AP1', displayId: '#AP1', name: 'TÃºi Coach', price: 8000000, brand: 'Coach', type: 'Phá»¥ kiá»‡n', tier: 'Cao cáº¥p' },
    { id: 'FASHION_AP2', displayId: '#AP2', name: 'KÃ­nh Ray-Ban', price: 5000000, brand: 'Ray-Ban', type: 'Phá»¥ kiá»‡n', tier: 'Cao cáº¥p' },
    { id: 'FASHION_AP3', displayId: '#AP3', name: 'NÃ³n Gucci', price: 12000000, brand: 'Gucci', type: 'Phá»¥ kiá»‡n', tier: 'Cao cáº¥p' },

    // Phá»¥ kiá»‡n luxury (Accessory Luxury - AL)
    { id: 'FASHION_AL1', displayId: '#AL1', name: 'TÃºi Hermes Birkin', price: 500000000, brand: 'Hermes', type: 'Phá»¥ kiá»‡n', tier: 'Luxury' },
    { id: 'FASHION_AL2', displayId: '#AL2', name: 'KÃ­nh Cartier Diamond', price: 200000000, brand: 'Cartier', type: 'Phá»¥ kiá»‡n', tier: 'Luxury' },
    { id: 'FASHION_AL3', displayId: '#AL3', name: 'Äá»“ng há»“ Rolex Daytona', price: 1000000000, brand: 'Rolex', type: 'Phá»¥ kiá»‡n', tier: 'Luxury' }
  ],
  pets: [
    // Rank C - ThÃº cÆ°ng phá»• thÃ´ng
    { id: 'PET_1', displayId: '#TC1', name: 'MÃ¨o Anh lÃ´ng ngáº¯n', price: 4000000, type: 'MÃ¨o', food: 'CÃ¡, thá»©c Äƒn mÃ¨o', rarity: 'C' },
    { id: 'PET_2', displayId: '#TC2', name: 'ChÃ³ Corgi', price: 8000000, type: 'ChÃ³', food: 'Thá»©c Äƒn chÃ³, thá»‹t', rarity: 'C' },
    { id: 'PET_3', displayId: '#TC3', name: 'Váº¹t Nam Má»¹', price: 5000000, type: 'Chim', food: 'Háº¡t, trÃ¡i cÃ¢y', rarity: 'C' },

    // Rank B - ThÃº cÆ°ng Ä‘áº·c biá»‡t
    { id: 'PET_4', displayId: '#TB1', name: 'MÃ¨o Scottish Fold', price: 15000000, type: 'MÃ¨o', food: 'CÃ¡, thá»©c Äƒn mÃ¨o cao cáº¥p', rarity: 'B' },
    { id: 'PET_5', displayId: '#TB2', name: 'ChÃ³ Husky Siberian', price: 20000000, type: 'ChÃ³', food: 'Thá»©c Äƒn chÃ³ cao cáº¥p, thá»‹t', rarity: 'B' },
    { id: 'PET_6', displayId: '#TB3', name: 'Váº¹t Macaw Xanh-VÃ ng', price: 25000000, type: 'Chim', food: 'Háº¡t cao cáº¥p, trÃ¡i cÃ¢y', rarity: 'B' },

    // Rank A - ThÃº cÆ°ng hiáº¿m
    { id: 'PET_7', displayId: '#TA1', name: 'MÃ¨o Sphynx khÃ´ng lÃ´ng', price: 40000000, type: 'MÃ¨o', food: 'Thá»±c pháº©m Ä‘áº·c cháº¿ cho mÃ¨o Sphynx', rarity: 'A' },
    { id: 'PET_8', displayId: '#TA2', name: 'ChÃ³ Poodle Teacup', price: 50000000, type: 'ChÃ³', food: 'Thá»©c Äƒn cao cáº¥p Ä‘áº·c cháº¿', rarity: 'A' },
    { id: 'PET_9', displayId: '#TA3', name: 'Váº¹t African Grey', price: 45000000, type: 'Chim', food: 'Thá»©c Äƒn nháº­p kháº©u Ä‘áº·c biá»‡t', rarity: 'A' },

    // Rank S - ThÃº cÆ°ng quÃ½ hiáº¿m
    { id: 'PET_10', displayId: '#TS1', name: 'MÃ¨o Bengal Exotic', price: 100000000, type: 'MÃ¨o', food: 'Thá»±c pháº©m cao cáº¥p Ä‘áº·c cháº¿', rarity: 'S' },
    { id: 'PET_11', displayId: '#TS2', name: 'ChÃ³ Samoyed Tráº¯ng Tinh', price: 120000000, type: 'ChÃ³', food: 'Thá»©c Äƒn cao cáº¥p nháº­p kháº©u', rarity: 'S' },
    { id: 'PET_12', displayId: '#TS3', name: 'Váº¹t Hyacinth Macaw', price: 150000000, type: 'Chim', food: 'Thá»©c Äƒn Ä‘áº·c cháº¿ cao cáº¥p', rarity: 'S' },

    // Rank SS - ThÃº cÆ°ng cá»±c hiáº¿m
    { id: 'PET_13', displayId: '#TSS1', name: 'MÃ¨o Maine Coon Khá»•ng Lá»“', price: 200000000, type: 'MÃ¨o', food: 'Thá»±c pháº©m siÃªu cao cáº¥p Ä‘áº·c cháº¿', rarity: 'SS' },
    { id: 'PET_14', displayId: '#TSS2', name: 'ChÃ³ Alaskan Malamute Thuáº§n Chá»§ng', price: 250000000, type: 'ChÃ³', food: 'Thá»©c Äƒn siÃªu cao cáº¥p Ä‘áº·c cháº¿', rarity: 'SS' },
    { id: 'PET_15', displayId: '#TSS3', name: 'Váº¹t Scarlet Macaw Äá»™t Biáº¿n', price: 300000000, type: 'Chim', food: 'Thá»©c Äƒn siÃªu cao cáº¥p nháº­p kháº©u', rarity: 'SS' },

    // Rank SSS - ThÃº cÆ°ng siÃªu hiáº¿m
    { id: 'PET_16', displayId: '#TSSS1', name: 'MÃ¨o Savannah F1', price: 400000000, type: 'MÃ¨o', food: 'Thá»±c pháº©m siÃªu cao cáº¥p nháº­p kháº©u', rarity: 'SSS' },
    { id: 'PET_17', displayId: '#TSSS2', name: 'ChÃ³ Tibetan Mastiff Thuáº§n Chá»§ng', price: 500000000, type: 'ChÃ³', food: 'Thá»©c Äƒn siÃªu cao cáº¥p nháº­p kháº©u', rarity: 'SSS' },
    { id: 'PET_18', displayId: '#TSSS3', name: 'Váº¹t Palm Cockatoo Äá»™t Biáº¿n', price: 550000000, type: 'Chim', food: 'Thá»©c Äƒn siÃªu cao cáº¥p Ä‘áº·c biá»‡t', rarity: 'SSS' },

    // Rank SSS+ - ThÃº cÆ°ng huyá»n thoáº¡i
    { id: 'PET_19', displayId: '#TSSS+1', name: 'MÃ¨o Ashera Lai Äáº·c Biá»‡t', price: 800000000, type: 'MÃ¨o', food: 'Thá»±c pháº©m huyá»n thoáº¡i Ä‘áº·c cháº¿', rarity: 'SSS+' },
    { id: 'PET_20', displayId: '#TSSS+2', name: 'ChÃ³ Tibetan Mastiff Báº¡ch Táº¡ng', price: 900000000, type: 'ChÃ³', food: 'Thá»©c Äƒn huyá»n thoáº¡i Ä‘áº·c cháº¿', rarity: 'SSS+' },
    { id: 'PET_21', displayId: '#TSSS+3', name: 'Váº¹t Spix Macaw Äá»™t Biáº¿n', price: 1000000000, type: 'Chim', food: 'Thá»©c Äƒn huyá»n thoáº¡i Ä‘áº·c biá»‡t', rarity: 'SSS+' }
  ],
  vehicles: [
    // PhÆ°Æ¡ng tiá»‡n cÆ¡ báº£n
    { id: 'VEHICLE_1', displayId: '#CB1', name: 'Xe Ä‘áº¡p', price: 2500000, type: 'Xe Ä‘áº¡p', fuel: 'KhÃ´ng cáº§n', tier: 'CÆ¡ báº£n' },
    { id: 'VEHICLE_2', displayId: '#CB2', name: 'Xe mÃ¡y 50cc', price: 7500000, type: 'Xe mÃ¡y', fuel: 'XÄƒng', tier: 'CÆ¡ báº£n' },
    { id: 'VEHICLE_3', displayId: '#CB3', name: 'Xe mÃ¡y PCX', price: 15000000, type: 'Xe mÃ¡y', fuel: 'XÄƒng', tier: 'CÆ¡ báº£n' },

    // Xe Ä‘iá»‡n cao cáº¥p
    { id: 'VEHICLE_4', displayId: '#XD1', name: 'Xe hÆ¡i Vinfast VF5', price: 1000000000, type: 'Ã” tÃ´', fuel: 'Äiá»‡n', tier: 'Cao cáº¥p' },
    { id: 'VEHICLE_5', displayId: '#XD2', name: 'Xe hÆ¡i Vinfast VF8', price: 2000000000, type: 'Ã” tÃ´', fuel: 'Äiá»‡n', tier: 'Cao cáº¥p' },

    // Xe xÄƒng cao cáº¥p
    { id: 'VEHICLE_6', displayId: '#XX1', name: 'Mercedes C300', price: 3000000000, type: 'Ã” tÃ´', fuel: 'XÄƒng', tier: 'Cao cáº¥p' },
    { id: 'VEHICLE_7', displayId: '#XX2', name: 'BMW 7 Series', price: 5000000000, type: 'Ã” tÃ´', fuel: 'XÄƒng', tier: 'Cao cáº¥p' },

    // PhÆ°Æ¡ng tiá»‡n Ä‘áº·c biá»‡t
    { id: 'VEHICLE_8', displayId: '#DB1', name: 'Du thuyá»n Sea Ray', price: 10000000000, type: 'Thuyá»n', fuel: 'Dáº§u', tier: 'Äáº·c biá»‡t' },
    { id: 'VEHICLE_9', displayId: '#DB2', name: 'MÃ¡y bay riÃªng Cessna', price: 50000000000, type: 'MÃ¡y bay', fuel: 'NhiÃªn liá»‡u mÃ¡y bay', tier: 'Äáº·c biá»‡t' }
  ]
};

function getRandomItem() {
  const rand = Math.random();
  let rarity;
  if (rand < 0.4) rarity = 'basic';              // 40%
  else if (rand < 0.7) rarity = 'accessory';       // 30%
  else if (rand < 0.9) rarity = 'ultra';           // 20%
  else if (rand < 0.9999) rarity = 'ultra_rare';   // 9.99%
  else if (rand < 0.999999) rarity = 'super_ultra_rare'; // 0.0099%
  else rarity = 'ssur';                            // 0.0001%

  const list = rareItems[rarity];
  return list[Math.floor(Math.random() * list.length)];
}

function findItemById(searchId) {
  // TÃ¬m trong rare items
  for (const rarity in rareItems) {
    const item = rareItems[rarity].find(item => item.id === searchId);
    if (item) return { ...item, rarity, type: 'rare' };
  }
  
  // TÃ¬m trong shop items
  for (const category in shopItems) {
    const item = shopItems[category].find(item => 
      item.id === searchId || item.displayId === searchId);
    if (item) return { ...item, category, type: 'shop' };
  }
  
  return null;
}

function getAllItemsList(showDetails = false) {
  let result = '';
  const rarityEmojis = {
    basic: 'âšª',
    accessory: 'ğŸŸ¢',
    ultra: 'ğŸ”µ',
    ultra_rare: 'ğŸŸ£',
    super_ultra_rare: 'ğŸŸ¡',
    ssur: 'ğŸ”´'
  };
  
  const rarityNames = {
    basic: 'ThÆ°á»ng',
    accessory: 'Phá»¥ kiá»‡n',
    ultra: 'Hiáº¿m',
    ultra_rare: 'Cá»±c Hiáº¿m',
    super_ultra_rare: 'SiÃªu Hiáº¿m',
    ssur: 'Tháº§n Thoáº¡i'
  };

  result += '**ğŸ Váº¬T PHáº¨M HIáº¾M (EVENT/Há»˜P QUÃ€):**\n';
  for (const rarity in rareItems) {
    result += `\n${rarityEmojis[rarity]} **${rarityNames[rarity].toUpperCase()}:**\n`;
    rareItems[rarity].forEach(item => {
      if (showDetails) {
        result += `${item.id} - ${item.name} (${item.sellPrice.toLocaleString('vi-VN')} VND)\n`;
      } else {
        result += `${item.name}\n`;
      }
    });
  }
  return result;
}

function getShopItemsList(category = null, showDetails = false) {
  const categoryEmojis = {
    fashion: 'ğŸ‘•',
    pets: 'ğŸ±',
    vehicles: 'ğŸš—'
  };

  const categoryNames = {
    fashion: 'THá»œI TRANG',
    pets: 'THÃš CÆ¯NG',
    vehicles: 'PHÆ¯Æ NG TIá»†N'
  };

  let result = '';
  
  if (category) {
    // Hiá»ƒn thá»‹ má»™t danh má»¥c
    const items = shopItems[category];
    if (!items) return 'Danh má»¥c khÃ´ng tá»“n táº¡i!';

    result = `${categoryEmojis[category]} **${categoryNames[category]}:**\n\n`;
    items.forEach(item => {
      if (showDetails) {
        let details = `${item.displayId} | ${item.name} (${item.price.toLocaleString('vi-VN')} VND)`;
        if (item.type) details += `\nLoáº¡i: ${item.type}`;
        if (item.food) details += `\nThá»©c Äƒn: ${item.food}`;
        if (item.fuel) details += `\nNhiÃªn liá»‡u: ${item.fuel}`;
        if (item.rarity) details += `\nÄá»™ hiáº¿m: ${item.rarity}`;
        if (item.brand) details += `\nThÆ°Æ¡ng hiá»‡u: ${item.brand}`;
        result += `${details}\n\n`;
      } else {
        result += `${item.displayId} | ${item.name} - ${item.price.toLocaleString('vi-VN')} VND\n`;
      }
    });
  } else {
    // Hiá»ƒn thá»‹ táº¥t cáº£ danh má»¥c
    for (const cat in shopItems) {
      result += `${categoryEmojis[cat]} **${categoryNames[cat]}:**\n`;
      shopItems[cat].forEach(item => {
        if (showDetails) {
          let details = `${item.id} - ${item.name} (${item.price.toLocaleString('vi-VN')} VND)`;
          if (item.type) details += `\nLoáº¡i: ${item.type}`;
          if (item.food) details += `\nThá»©c Äƒn: ${item.food}`;
          if (item.fuel) details += `\nNhiÃªn liá»‡u: ${item.fuel}`;
          result += `${details}\n\n`;
        } else {
          result += `${item.name} - ${item.price.toLocaleString('vi-VN')} VND\n`;
        }
      });
      result += '\n';
    }
  }
  
  return result;
}

const questions = [
  {
    question: "Con gÃ¬ cÃ³ 4 chÃ¢n nhÆ°ng khÃ´ng cháº¡y?",
    options: ["BÃ n", "Gháº¿", "Cá»­a"],
    correct: 0
  },
  {
    question: "CÃ¡i gÃ¬ mÃ  Ä‘i thÃ¬ náº±m, Ä‘á»©ng thÃ¬ bay?",
    options: ["Äá»“ng há»“", "MÃ¡y bay", "Cáº§u thang"],
    correct: 0
  },
  {
    question: "Loáº¡i quáº£ nÃ o cÃ³ nhiá»u vitamin C nháº¥t?",
    options: ["Cam", "TÃ¡o", "Chuá»‘i"],
    correct: 0
  },
  {
    question: "Con váº­t nÃ o cÃ³ cá»• dÃ i nháº¥t?",
    options: ["HÆ°Æ¡u cao cá»•", "Ngá»±a", "Voi"],
    correct: 0
  },
  {
    question: "CÃ¡i gÃ¬ cÃ³ máº¯t nhÆ°ng khÃ´ng nhÃ¬n tháº¥y?",
    options: ["Kim mÅ©i khÃ¢u", "CÃ¢y kim", "BÃºt chÃ¬"],
    correct: 0
  }
];

const numberEmojis = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£'];

// Casino functions
function getCardValue(card) {
  if (card === 'A') return 11;
  if (['J', 'Q', 'K'].includes(card)) return 10;
  return parseInt(card);
}

function getHandValue(hand) {
  let value = 0;
  let aces = 0;
  for (let card of hand) {
    if (card === 'A') {
      aces++;
      value += 11;
    } else if (['J', 'Q', 'K'].includes(card)) {
      value += 10;
    } else {
      value += parseInt(card);
    }
  }
  while (value > 21 && aces > 0) {
    value -= 10;
    aces--;
  }
  return value;
}

function createDeck() {
  const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
  const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
  const deck = [];
  for (let suit of suits) {
    for (let value of values) {
      deck.push(value + suit);
    }
  }
  return deck;
}

function shuffleDeck(deck) {
  for (let i = deck.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [deck[i], deck[j]] = [deck[j], deck[i]];
  }
  return deck;
}

function drawCard(deck, isDealer = false, isDealerFirstDraw = false, dealerFirstCard = null) {
  if (isDealer) {
    if (isDealerFirstDraw) {
      // 30% cÆ¡ há»™i nhÃ  cÃ¡i Ä‘Æ°á»£c A trong lÃ¡ Ä‘áº§u tiÃªn
      if (Math.random() < 0.3) {
        const aceCard = deck.find(card => card[0] === 'A');
        if (aceCard) {
          const index = deck.indexOf(aceCard);
          deck.splice(index, 1);
          return aceCard;
        }
      }
    } else if (dealerFirstCard && dealerFirstCard[0] === 'A') {
      // Náº¿u lÃ¡ Ä‘áº§u lÃ  A, 40% cÆ¡ há»™i lÃ¡ thá»© 2 lÃ  10, J, Q, K
      if (Math.random() < 0.4) {
        const tenCard = deck.find(card => ['10', 'J', 'Q', 'K'].includes(card[0]));
        if (tenCard) {
          const index = deck.indexOf(tenCard);
          deck.splice(index, 1);
          return tenCard;
        }
      }
    } else if (dealerFirstCard && ['10', 'J', 'Q', 'K'].includes(dealerFirstCard[0])) {
      // Náº¿u lÃ¡ Ä‘áº§u lÃ  10/J/Q/K, 40% cÆ¡ há»™i lÃ¡ thá»© 2 lÃ  A
      if (Math.random() < 0.4) {
        const aceCard = deck.find(card => card[0] === 'A');
        if (aceCard) {
          const index = deck.indexOf(aceCard);
          deck.splice(index, 1);
          return aceCard;
        }
      }
    } else if (Math.random() < 0.6) { // 60% cÆ¡ há»™i nhÃ  cÃ¡i Ä‘Æ°á»£c bÃ i tá»‘t cho cÃ¡c láº§n rÃºt khÃ¡c
      const lastFiveCards = deck.slice(-5);
      const highCard = lastFiveCards.find(card => ['J', 'Q', 'K', 'A'].includes(card[0]));
      if (highCard) {
        const index = deck.indexOf(highCard);
        deck.splice(index, 1);
        return highCard;
      }
    }
  }
  return deck.pop();
}

function getCardDisplay(card) {
  return `\`${card}\``;
}

const jobs = [
  { name: 'Designer', payPerHour: 50000, isCommission: false },
  { name: 'Coder', payPerHour: 80000, isCommission: false },
  { name: 'Shipper', payPerHour: 30000, isCommission: true },
  { name: 'Teacher', payPerHour: 60000, isCommission: false },
  { name: 'Doctor', payPerHour: 100000, isCommission: false },
  { name: 'Chef', payPerHour: 40000, isCommission: false },
  { name: 'Driver', payPerHour: 35000, isCommission: true },
  { name: 'Writer', payPerHour: 45000, isCommission: false },
];

client.once('clientReady', () => {
  console.log('Bot Ä‘Ã£ sáºµn sÃ ng!');
});

client.on('voiceStateUpdate', (oldState, newState) => {
  const userId = newState.id;
  const user = userData[userId] || { lastCheckin: null, streak: 0, totalCheckins: 0, money: 0, xp: 0, voiceJoinTime: null, lastLevel: 1, inventory: [], isSearchingJob: false };

  if (!oldState.channel && newState.channel) {
    // Joined voice
    user.voiceJoinTime = Date.now();
  } else if (oldState.channel && !newState.channel) {
    // Left voice
    if (user.voiceJoinTime) {
      const timeInVoice = Date.now() - user.voiceJoinTime;
      const xpGain = Math.floor(timeInVoice / 60000) * 20; // 20 XP per minute in voice
      user.xp += xpGain;
      user.voiceJoinTime = null;
      // Optional: notify user
    }
  }

  userData[userId] = user;
  saveData();
});

// Ensure only one messageCreate listener
if (client.listenerCount('messageCreate') === 0) {
  client.on('messageCreate', async (message) => {
    if (message.author.bot) return;

  // XP for chat (light, with cooldown)
  const now = Date.now();
  const lastTime = lastMessageTime.get(message.author.id) || 0;
  if (now - lastTime > 60000) { // 1 minute cooldown
    const user = userData[message.author.id] || { lastCheckin: null, streak: 0, totalCheckins: 0, money: 0, xp: 0, lastLevel: 1, inventory: [], isSearchingJob: false };
    user.xp += 10; // 10 XP per message with cooldown
    checkLevelUp(user, message);
    userData[message.author.id] = user;
    saveData();
    lastMessageTime.set(message.author.id, now);
  }

  if (message.content === '!ping') {
    message.reply('Pong!');
  }

  if (message.content === '!help') {
    const helpEmbed = new EmbedBuilder()
      .setTitle('ğŸ“š HÆ¯á»šNG DáºªN Sá»¬ Dá»¤NG BOT')
      .setColor('#0099FF')
      .setDescription('Danh sÃ¡ch cÃ¡c lá»‡nh cÃ³ sáºµn:')
      .addFields(
        { 
          name: 'ğŸ’° Lá»†NH CÆ  Báº¢N', 
          value: '`!ping` - Kiá»ƒm tra bot\n`!help` - Hiá»ƒn thá»‹ hÆ°á»›ng dáº«n\n`!checkin` - Äiá»ƒm danh hÃ ng ngÃ y\n`!profile` - Xem profile cá»§a báº¡n\n`!inventory` - Xem tÃºi Ä‘á»“\n`!sell <sá»‘>` - BÃ¡n item (VD: !sell 1)\n`!resetdata` - Reset data cá»§a báº¡n',
          inline: false 
        },
        { 
          name: 'ğŸ’¼ Lá»†NH NGHá»€ NGHIá»†P', 
          value: '`!timviec` - TÃ¬m viá»‡c lÃ m (chá»n nghá» qua reaction)\n`!work` - LÃ m viá»‡c Ä‘á»ƒ kiáº¿m tiá»n (1 láº§n/ngÃ y)',
          inline: false 
        },
        { 
          name: 'ğŸ° Lá»†NH CASINO', 
          value: '`!bacay <tiá»n>` - Ba cÃ¢y (Tá»· lá»‡ 1:1)\n`!xidach <tiá»n>` - XÃ¬ dÃ¡ch/Blackjack (Tá»· lá»‡ 1:1.5)\n`!ngua <tiá»n>` - Tung xu máº·t ngá»­a (Tá»· lá»‡ 1:1)\n`!sap <tiá»n>` - Tung xu máº·t sáº¥p (Tá»· lá»‡ 1:1)\n`!slot <tiá»n>` - Quay slot (Tá»· lá»‡ lÃªn Ä‘áº¿n 1:20)\n\nğŸ’¡ **Máº¹o:** DÃ¹ng `all` thay vÃ¬ sá»‘ tiá»n Ä‘á»ƒ cÆ°á»£c toÃ n bá»™!\nVÃ­ dá»¥: `!bacay all`, `!slot all`',
          inline: false 
        },
        {
          name: 'ğŸ¦ NGÃ‚N HÃ€NG',
          value: '`!bank` - Xem thÃ´ng tin tÃ i khoáº£n ngÃ¢n hÃ ng\n`!deposit <sá»‘ tiá»n>` - Náº¡p tiá»n vÃ o tÃ i khoáº£n\n`!withdraw <sá»‘ tiá»n>` - RÃºt tiá»n tá»« tÃ i khoáº£n\n`!transfer <@user> <sá»‘ tiá»n> [ghi chÃº]` - Chuyá»ƒn tiá»n cho ngÆ°á»i khÃ¡c\n`!history` - Xem lá»‹ch sá»­ giao dá»‹ch',
          inline: false
        },
        {
          name: 'ğŸ›ï¸ Cá»¬A HÃ€NG',
          value: '`!shop` - Xem danh sÃ¡ch cá»­a hÃ ng\n`!shop fashion` - Cá»­a hÃ ng thá»i trang\n`!shop pets` - Cá»­a hÃ ng thÃº cÆ°ng\n`!shop vehicles` - Cá»­a hÃ ng phÆ°Æ¡ng tiá»‡n\n`!buy <ID>` - Mua váº­t pháº©m (VD: !buy F1)',
          inline: false
        },
        {
          name: 'ğŸ“Š Xáº¾P Háº NG',
          value: '`!toprich` - Top 10 ngÆ°á»i giÃ u nháº¥t\n`!toplevel` - Top 10 level cao nháº¥t',
          inline: false
        },
        { 
          name: 'ğŸ“‹ THÃ”NG TIN THÃŠM', 
          value: 'â€¢ Äiá»ƒm danh liÃªn tá»¥c Ä‘á»ƒ tÄƒng streak vÃ  nháº­n thÆ°á»Ÿng lá»›n!\nâ€¢ Level tÄƒng qua XP tá»« chat, voice, check-in\nâ€¢ Má»—i 5 level nháº­n há»™p quÃ  3 item\nâ€¢ Casino: Jackpot 7ï¸âƒ£ trong slot = x20 tiá»n cÆ°á»£c!\nâ€¢ DÃ¹ng `!transfer <@user> all` Ä‘á»ƒ chuyá»ƒn toÃ n bá»™ sá»‘ dÆ°\nâ€¢ Voice chat nháº­n 20 XP/phÃºt',
          inline: false 
        }
      )
      .setFooter({ text: 'ğŸ® MAN88 Bot - ChÃºc báº¡n chÆ¡i vui váº»!' })
      .setTimestamp();

    message.reply({ embeds: [helpEmbed] });
  }

  if (message.content === '!checkin') {
    const commandNow = Date.now();
    const cooldownTime = 2000; // 2 seconds
    if (commandCooldown.has(message.author.id)) {
      const lastUsed = commandCooldown.get(message.author.id);
      if (commandNow - lastUsed < cooldownTime) {
        return message.reply('Vui lÃ²ng chá» má»™t chÃºt trÆ°á»›c khi dÃ¹ng lá»‡nh nÃ y láº¡i.');
      }
    }
    commandCooldown.set(message.author.id, commandNow);

    const userId = message.author.id;
    const guild = message.guild;
    const member = guild.members.cache.get(userId);

    if (!member) {
      return message.reply('KhÃ´ng tÃ¬m tháº¥y thÃ nh viÃªn!');
    }

    // Bá» check online status, cho phÃ©p táº¥t cáº£ tráº¡ng thÃ¡i

    const now = new Date();
    const today = now.toDateString();
    const user = userData[userId] || { lastCheckin: null, streak: 0, totalCheckins: 0, money: 0, xp: 0, lastLevel: 1, inventory: [], isSearchingJob: false };

    let rewardMoney = 5000; // Base daily reward
    let rewardXp = 20; // Base XP for checkin

    if (user.lastCheckin) {
      const lastDate = new Date(user.lastCheckin);
      const diffDays = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));

      if (diffDays === 1) {
        user.streak += 1;
      } else if (diffDays > 1) {
        user.streak = 1; // Reset streak
      }
      // If same day, no reward
      if (diffDays === 0) {
        return message.reply('Báº¡n Ä‘Ã£ Ä‘iá»ƒm danh hÃ´m nay rá»“i!');
      }
    } else {
      user.streak = 1;
    }

    // Bonus for streak
    rewardMoney += user.streak * 2000;
    rewardXp += user.streak;

    // Weekly bonus
    if (user.streak % 7 === 0) {
      rewardMoney += 100000;
      rewardXp += 100;
      message.reply(`**Pháº§n thÆ°á»Ÿng tuáº§n!** Streak ${user.streak} ngÃ y!`);
    }

    // Monthly bonus
    if (user.streak % 30 === 0) {
      rewardMoney += 1000000;
      rewardXp += 400;
      message.reply(`**Pháº§n thÆ°á»Ÿng thÃ¡ng!** Streak ${user.streak} ngÃ y!`);
    }

    user.lastCheckin = today;
    user.totalCheckins += 1;
    user.money += rewardMoney;
    user.xp += rewardXp;

    checkLevelUp(user, message);

    userData[userId] = user;
    saveData();

    const embed = new EmbedBuilder()
      .setColor('#00FF00')
      .setTitle('Äiá»ƒm danh thÃ nh cÃ´ng! ğŸ‰')
      .setDescription(`ChÃºc má»«ng ${message.author.username}!`)
      .addFields(
        { name: 'ğŸ”¥ Streak', value: `${user.streak} ngÃ y`, inline: true },
        { name: 'ğŸ’° Pháº§n thÆ°á»Ÿng tiá»n', value: `${rewardMoney.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ“ˆ Pháº§n thÆ°á»Ÿng XP', value: `${rewardXp}`, inline: true },
        { name: 'ğŸ’µ Tá»•ng tiá»n', value: `${user.money.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ“Š Tá»•ng XP', value: `${user.xp}`, inline: true },
        { name: 'ğŸ“… Tá»•ng check-in', value: `${user.totalCheckins}`, inline: true }
      )
      .setFooter({ text: 'HÃ£y tiáº¿p tá»¥c streak Ä‘á»ƒ nháº­n thÆ°á»Ÿng lá»›n!' });

    message.reply({ embeds: [embed] });
  }

  if (message.content === '!profile') {
    const commandNow = Date.now();
    const cooldownTime = 5000; // 5 seconds
    if (commandCooldown.has(message.author.id)) {
      const lastUsed = commandCooldown.get(message.author.id);
      if (commandNow - lastUsed < cooldownTime) {
        return message.reply('Vui lÃ²ng chá» má»™t chÃºt trÆ°á»›c khi dÃ¹ng lá»‡nh nÃ y láº¡i.');
      }
    }
    commandCooldown.set(message.author.id, commandNow);

    console.log('Profile command used by', message.author.username);
    const userId = message.author.id;
    const user = userData[userId] || { lastCheckin: null, streak: 0, totalCheckins: 0, money: 0, xp: 0, lastLevel: 1, inventory: [], isSearchingJob: false };

    const { level, nextXp } = getLevelInfo(user.xp);

    const embed = new EmbedBuilder()
      .setColor('#0099FF')
      .setTitle(`Profile cá»§a ${message.author.username}`)
      .setThumbnail(message.author.displayAvatarURL())
      .addFields(
        { name: 'ğŸ’µ Tiá»n', value: `${user.money.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ“Š XP', value: `${user.xp}`, inline: true },
        { name: 'ğŸ† Level', value: `${level}`, inline: true },
        { name: 'ğŸ”¥ Streak', value: `${user.streak} ngÃ y`, inline: true },
        { name: 'ğŸ“… Tá»•ng check-in', value: `${user.totalCheckins}`, inline: true },
        { name: 'â¬†ï¸ XP cáº§n cho level tiáº¿p', value: `${nextXp}`, inline: true },
        { name: 'ğŸ’¼ Nghá» nghiá»‡p', value: user.selectedJob || 'ChÆ°a chá»n nghá»', inline: true }
      )
      .setFooter({ text: 'Tiáº¿p tá»¥c check-in Ä‘á»ƒ tÄƒng level vÃ  tiá»n!' });

    message.reply({ embeds: [embed] });
  }

  if (message.content === '!inventory') {
    const commandNow = Date.now();
    const cooldownTime = 2000; // 2 seconds
    if (commandCooldown.has(message.author.id)) {
      const lastUsed = commandCooldown.get(message.author.id);
      if (commandNow - lastUsed < cooldownTime) {
        return message.reply('Vui lÃ²ng chá» má»™t chÃºt trÆ°á»›c khi dÃ¹ng lá»‡nh nÃ y láº¡i.');
      }
    }
    commandCooldown.set(message.author.id, commandNow);

    const user = userData[message.author.id] || { inventory: [], isSearchingJob: false };
    if (!user.inventory || user.inventory.length === 0) {
      message.reply('TÃºi Ä‘á»“ trá»‘ng!');
      return;
    }
    let desc = '';
    user.inventory.forEach((item, index) => {
      desc += `${index + 1}. ${item.name} - BÃ¡n: ${item.sellPrice.toLocaleString('vi-VN')} VND\n`;
    });
    const embed = new EmbedBuilder()
      .setTitle(`TÃºi Ä‘á»“ cá»§a ${message.author.username}`)
      .setDescription(desc)
      .setColor('#FFA500');
    message.reply({ embeds: [embed] });
  }

  if (message.content.startsWith('!sell ')) {
    const commandNow = Date.now();
    const cooldownTime = 2000; // 2 seconds
    if (commandCooldown.has(message.author.id)) {
      const lastUsed = commandCooldown.get(message.author.id);
      if (commandNow - lastUsed < cooldownTime) {
        return message.reply('Vui lÃ²ng chá» má»™t chÃºt trÆ°á»›c khi dÃ¹ng lá»‡nh nÃ y láº¡i.');
      }
    }
    commandCooldown.set(message.author.id, commandNow);

    const args = message.content.split(' ');
    const index = parseInt(args[1]) - 1;
    const user = userData[message.author.id] || { inventory: [], money: 0, isSearchingJob: false };
    if (!user.inventory || index < 0 || index >= user.inventory.length) {
      message.reply('Item khÃ´ng tá»“n táº¡i!');
      return;
    }
    const item = user.inventory.splice(index, 1)[0];
    user.money += item.sellPrice;
    userData[message.author.id] = user;
    saveData();
    message.reply(`ÄÃ£ bÃ¡n ${item.name} cho ${item.sellPrice.toLocaleString('vi-VN')} VND. Tá»•ng tiá»n: ${user.money.toLocaleString('vi-VN')} VND.`);
  }

  if (message.content.startsWith('!resetdata')) {
    const now = Date.now();
    const cooldownTime = 30000; // 30 seconds
    if (commandCooldown.has(message.author.id)) {
      const lastUsed = commandCooldown.get(message.author.id);
      if (now - lastUsed < cooldownTime) {
        return message.reply('Vui lÃ²ng chá» má»™t chÃºt trÆ°á»›c khi dÃ¹ng lá»‡nh nÃ y láº¡i.');
      }
    }
    commandCooldown.set(message.author.id, now);

    // if (message.author.id !== ownerId) {
    //   return message.reply('Chá»‰ owner má»›i cÃ³ thá»ƒ dÃ¹ng lá»‡nh nÃ y!');
    // }

    const args = message.content.split(' ');
    const targetUserId = args[1] || message.author.id; // Náº¿u khÃ´ng chá»‰ Ä‘á»‹nh, reset chÃ­nh mÃ¬nh

    if (message.author.id !== ownerId && targetUserId !== message.author.id) {
      return message.reply('Báº¡n chá»‰ cÃ³ thá»ƒ reset data cá»§a chÃ­nh mÃ¬nh!');
    }

    if (userData[targetUserId]) {
      delete userData[targetUserId];
      saveData();
      // Reset only certain maps, keep cooldown to prevent spam
      profileProcessing.delete(targetUserId);
      lastMessageTime.delete(targetUserId);
      return message.reply(`ÄÃ£ reset data cá»§a user ${targetUserId}.`);
    } else {
      return message.reply('User chÆ°a cÃ³ data.');
    }
  }

  if (message.content === '!timviec') {
    const commandNow = Date.now();
    const cooldownTime = 2000; // 2 seconds
    if (commandCooldown.has(message.author.id)) {
      const lastUsed = commandCooldown.get(message.author.id);
      if (commandNow - lastUsed < cooldownTime) {
        return message.reply('Vui lÃ²ng chá» má»™t chÃºt trÆ°á»›c khi dÃ¹ng lá»‡nh nÃ y láº¡i.');
      }
    }
    commandCooldown.set(message.author.id, commandNow);

  const userId = message.author.id;

  const user = userData[userId] || {
    lastCheckin: null, streak: 0, totalCheckins: 0,
    money: 0, xp: 0, lastLevel: 1, inventory: [],
    lastWork: null, selectedJob: null, attemptsToday: 0, isSearchingJob: false
  };

  if (user.isSearchingJob) {
    return message.reply('Báº¡n Ä‘ang trong quÃ¡ trÃ¬nh thá»­ viá»‡c, vui lÃ²ng hoÃ n thÃ nh trÆ°á»›c khi tÃ¬m viá»‡c má»›i.');
  }

  try {

    const now = new Date();
    const today = now.toDateString();

    if (user.lastWork !== today) {
      user.attemptsToday = 0;
      user.selectedJob = null;
      user.lastWork = today;
    }

    if (user.selectedJob)
      return message.reply('âœ… Báº¡n Ä‘Ã£ cÃ³ nghá» rá»“i! DÃ¹ng !work Ä‘á»ƒ lÃ m viá»‡c.');
    if (user.attemptsToday >= 3)
      return message.reply('ğŸš« Báº¡n Ä‘Ã£ thá»­ viá»‡c 3 láº§n hÃ´m nay, hÃ£y quay láº¡i vÃ o ngÃ y mai.');

    // Táº¡o embed danh sÃ¡ch nghá»
    let desc = 'Chá»n nghá» cá»§a báº¡n báº±ng cÃ¡ch react emoji:\n\n';
    jobs.forEach((job, index) => {
      desc += `${numberEmojis[index]} **${job.name}** â€” ğŸ’° ${job.payPerHour.toLocaleString('vi-VN')} VND/giá»\n`;
    });

    const embed = new EmbedBuilder()
      .setTitle('ğŸ¢ TRUNG TÃ‚M GIá»šI THIá»†U VIá»†C LÃ€M')
      .setDescription(desc)
      .setColor('#FFA500');

    const jobMsg = await message.reply({ embeds: [embed] });
    for (let i = 0; i < jobs.length; i++) {
      await jobMsg.react(numberEmojis[i]);
    }

    user.isSearchingJob = true;
    userData[userId] = user;
    saveData();

    // Collector khÃ´ng giá»›i háº¡n thá»i gian
    const filter = (reaction, userReact) =>
      numberEmojis.includes(reaction.emoji.name) && userReact.id === userId;

    const collector = jobMsg.createReactionCollector({ filter, max: 1, time: 60000 }); // 1 minute timeout

    collector.on('collect', async (reaction) => {
      try {
        const choice = numberEmojis.indexOf(reaction.emoji.name);
        const job = jobs[choice];

        await jobMsg.reactions.removeAll().catch(() => {});

        // CÃ¢u há»i thá»­ viá»‡c
        const question = questions[Math.floor(Math.random() * questions.length)];
        let qDesc = `${question.question}\n\n`;
        question.options.forEach((opt, idx) => {
          qDesc += `${numberEmojis[idx]} ${opt}\n`;
        });

        const qEmbed = new EmbedBuilder()
          .setTitle('ğŸ§  THá»¬ VIá»†C')
          .setDescription(qDesc)
          .setColor('#FFA500');

        const qMsg = await message.reply({ embeds: [qEmbed] });
        for (let i = 0; i < question.options.length; i++) {
          await qMsg.react(numberEmojis[i]);
        }

        const qFilter = (reaction, userReact) =>
          numberEmojis.slice(0, question.options.length).includes(reaction.emoji.name) &&
          userReact.id === userId;

        const qCollector = qMsg.createReactionCollector({ filter: qFilter, max: 1 });

        qCollector.on('collect', async (ansReaction) => {
          const answer = numberEmojis.indexOf(ansReaction.emoji.name);

          await qMsg.reactions.removeAll().catch(() => {});

          if (answer !== question.correct) {
            user.attemptsToday += 1;
            user.isSearchingJob = false;
            userData[userId] = user;
            saveData();
            return message.reply(`âŒ Tráº£ lá»i sai! Báº¡n cÃ²n ${3 - user.attemptsToday} láº§n thá»­ hÃ´m nay.`);
          }

          // Tráº£ lá»i Ä‘Ãºng
          user.selectedJob = job.name;
          user.attemptsToday = 0;
          user.lastWork = null; // Reset Ä‘á»ƒ cho phÃ©p work ngay sau khi tÃ¬m viá»‡c thÃ nh cÃ´ng
          user.isSearchingJob = false;
          userData[userId] = user;
          saveData();

          return message.reply(`ğŸ‰ ChÃºc má»«ng! Báº¡n Ä‘Ã£ Ä‘Æ°á»£c nháº­n lÃ m **${job.name}**!\nDÃ¹ng lá»‡nh **!work** Ä‘á»ƒ báº¯t Ä‘áº§u lÃ m viá»‡c.`);
        });

      } catch (err) {
        console.error(err);
        message.reply('âš ï¸ Lá»—i khi xá»­ lÃ½ quÃ¡ trÃ¬nh chá»n nghá».');
        user.isSearchingJob = false;
        userData[userId] = user;
        saveData();
      }
    });

    collector.on('end', () => {
      user.isSearchingJob = false;
      userData[userId] = user;
      saveData();
    });

  } catch (err) {
    console.error(err);
    message.reply('âš ï¸ CÃ³ lá»—i xáº£y ra.');
    user.isSearchingJob = false;
    userData[userId] = user;
    saveData();
  }
}

  if (message.content === '!work') {
    const commandNow = Date.now();
    const cooldownTime = 2000; // 2 seconds
    if (commandCooldown.has(message.author.id)) {
      const lastUsed = commandCooldown.get(message.author.id);
      if (commandNow - lastUsed < cooldownTime) {
        return message.reply('Vui lÃ²ng chá» má»™t chÃºt trÆ°á»›c khi dÃ¹ng lá»‡nh nÃ y láº¡i.');
      }
    }
    commandCooldown.set(message.author.id, commandNow);

    const userId = message.author.id;
    const user = userData[userId] || { 
      lastCheckin: null, 
      streak: 0, 
      totalCheckins: 0, 
      money: 0, 
      xp: 0, 
      lastLevel: 1, 
      inventory: [], 
      lastWork: null,
      lastOvertimeWork: null, 
      selectedJob: null, 
      attemptsToday: 0, 
      isSearchingJob: false,
      overtimeCount: 0 // Sá»‘ láº§n Ä‘Ã£ lÃ m ngoÃ i giá» trong ngÃ y
    };

    const now = new Date();
    const today = now.toDateString();

    if (!user.selectedJob) {
      return message.reply('Báº¡n chÆ°a chá»n nghá»! DÃ¹ng !timviec Ä‘á»ƒ tÃ¬m viá»‡c trÆ°á»›c.');
    }

    const job = jobs.find(j => j.name === user.selectedJob);
    if (!job) {
      return message.reply('Lá»—i: Nghá» khÃ´ng tá»“n táº¡i.');
    }

    // Kiá»ƒm tra vÃ  thá»±c hiá»‡n cÃ´ng viá»‡c chÃ­nh
    if (!user.lastWork || user.lastWork !== today) {
      // Tiáº¿n hÃ nh lÃ m viá»‡c chÃ­nh
      const hours = 8;
      const basePay = hours * job.payPerHour;
      let bonus;
      if (job.isCommission) {
        bonus = Math.floor(Math.random() * 150000) + 10000;
      } else {
        bonus = Math.floor(Math.random() * 100000) + 50000;
      }
      const totalPay = basePay + bonus;

      user.money += totalPay;
      user.lastWork = today;
      user.overtimeCount = 0; // Reset sá»‘ láº§n lÃ m ngoÃ i giá» má»—i ngÃ y má»›i
      userData[userId] = user;
      saveData();

      const workEmbed = new EmbedBuilder()
        .setTitle('ğŸ¢ LÃ€M VIá»†C CHÃNH')
        .setColor('#00FF00')
        .addFields(
          { name: 'ğŸ’¼ CÃ´ng viá»‡c', value: `${job.name}`, inline: true },
          { name: 'â° Sá»‘ giá»', value: `${hours} giá»`, inline: true },
          { name: 'ğŸ’° LÆ°Æ¡ng cÆ¡ báº£n', value: `${basePay.toLocaleString('vi-VN')} VND`, inline: true },
          { name: 'ğŸ ThÆ°á»Ÿng', value: `${bonus.toLocaleString('vi-VN')} VND`, inline: true },
          { name: 'ğŸ’µ Tá»•ng nháº­n', value: `${totalPay.toLocaleString('vi-VN')} VND`, inline: true },
          { name: 'ğŸ¦ Sá»‘ dÆ°', value: `${user.money.toLocaleString('vi-VN')} VND`, inline: true }
        )
        .setFooter({ text: 'ğŸ’¡ Báº¡n cÃ³ thá»ƒ lÃ m thÃªm giá»! Sá»­ dá»¥ng !work má»™t láº§n ná»¯a.' });

      return message.reply({ embeds: [workEmbed] });
    }
    
    // Xá»­ lÃ½ lÃ m ngoÃ i giá» (chá»‰ hiá»ƒn thá»‹ sau khi Ä‘Ã£ lÃ m viá»‡c chÃ­nh)
    const maxOvertimePerDay = 3; // Tá»‘i Ä‘a 3 láº§n lÃ m ngoÃ i giá» má»™t ngÃ y
    if (user.overtimeCount >= maxOvertimePerDay) {
      return message.reply('âŒ Báº¡n Ä‘Ã£ lÃ m Ä‘á»§ sá»‘ giá» ngoÃ i giá» cho phÃ©p hÃ´m nay (tá»‘i Ä‘a 3 láº§n).');
    }

    // TÃ­nh lÆ°Æ¡ng lÃ m ngoÃ i giá» (50% lÆ°Æ¡ng cÆ¡ báº£n)
    const overtimeHours = 4; // LÃ m thÃªm 4 giá» má»—i láº§n
    const overtimePay = Math.floor((overtimeHours * job.payPerHour * 0.5));
    let overtimeBonus = 0;
    if (job.isCommission) {
      overtimeBonus = Math.floor(Math.random() * 50000) + 5000; // ThÆ°á»Ÿng ngoÃ i giá» tháº¥p hÆ¡n
    } else {
      overtimeBonus = Math.floor(Math.random() * 30000) + 10000;
    }
    const totalOvertimePay = overtimePay + overtimeBonus;

    user.money += totalOvertimePay;
    user.overtimeCount = (user.overtimeCount || 0) + 1;
    userData[userId] = user;
    saveData();

    const overtimeEmbed = new EmbedBuilder()
      .setTitle('ğŸŒ™ LÃ€M THÃŠM GIá»œ')
      .setColor('#FFA500')
      .addFields(
        { name: 'ğŸ’¼ CÃ´ng viá»‡c', value: `${job.name}`, inline: true },
        { name: 'â° Sá»‘ giá»', value: `${overtimeHours} giá»`, inline: true },
        { name: 'ğŸ’° LÆ°Æ¡ng ngoÃ i giá»', value: `${overtimePay.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ ThÆ°á»Ÿng', value: `${overtimeBonus.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ’µ Tá»•ng nháº­n', value: `${totalOvertimePay.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ¦ Sá»‘ dÆ°', value: `${user.money.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ“Š Sá»‘ láº§n cÃ²n láº¡i', value: `${maxOvertimePerDay - user.overtimeCount} láº§n`, inline: true }
      );

    message.reply({ embeds: [overtimeEmbed] });
  }

  // BA CÃ‚Y
  if (message.content.startsWith('!bacay')) {
    const commandNow = Date.now();
    const cooldownTime = 3000;
    if (commandCooldown.has(message.author.id)) {
      const lastUsed = commandCooldown.get(message.author.id);
      if (commandNow - lastUsed < cooldownTime) {
        return message.reply('Vui lÃ²ng chá» má»™t chÃºt trÆ°á»›c khi dÃ¹ng lá»‡nh nÃ y láº¡i.');
      }
    }
    commandCooldown.set(message.author.id, commandNow);

    const userId = message.author.id;
    const user = userData[userId] || { money: 0, isSearchingJob: false };

    const args = message.content.split(' ');
    let betAmount;

    if (args[1] === 'all') {
      betAmount = user.money;
    } else {
      betAmount = parseInt(args[1]);
    }

    if (!betAmount || betAmount <= 0) {
      return message.reply('CÃº phÃ¡p: `!bacay <sá»‘ tiá»n>` hoáº·c `!bacay all`\nVÃ­ dá»¥: `!bacay 10000`');
    }

    if (user.money < betAmount) {
      return message.reply(`Báº¡n khÃ´ng Ä‘á»§ tiá»n! Báº¡n chá»‰ cÃ³ ${user.money.toLocaleString('vi-VN')} VND.`);
    }

    const deck = shuffleDeck(createDeck());
    const playerCards = [drawCard(deck), drawCard(deck), drawCard(deck)];
    const dealerCards = [drawCard(deck, true), drawCard(deck, true), drawCard(deck, true)];

    const playerValue = (getCardValue(playerCards[0].slice(0, -1)) + 
                       getCardValue(playerCards[1].slice(0, -1)) + 
                       getCardValue(playerCards[2].slice(0, -1))) % 10;
    const dealerValue = (getCardValue(dealerCards[0].slice(0, -1)) + 
                       getCardValue(dealerCards[1].slice(0, -1)) + 
                       getCardValue(dealerCards[2].slice(0, -1))) % 10;

    const resultEmbed = new EmbedBuilder()
      .setTitle('ğŸ´ BA CÃ‚Y')
      .addFields(
        { name: 'ğŸ’° CÆ°á»£c', value: `${betAmount.toLocaleString('vi-VN')} VND`, inline: false },
        { name: 'ğŸ² BÃ i cá»§a báº¡n', value: `${playerCards.map(getCardDisplay).join(' ')} = **${playerValue} Ä‘iá»ƒm**`, inline: false },
        { name: 'ğŸ² BÃ i cá»§a nhÃ  cÃ¡i', value: `${dealerCards.map(getCardDisplay).join(' ')} = **${dealerValue} Ä‘iá»ƒm**`, inline: false }
      )
      .setColor(playerValue > dealerValue ? '#00FF00' : playerValue < dealerValue ? '#FF0000' : '#FFFF00');

    if (playerValue > dealerValue) {
      user.money += betAmount;
      resultEmbed.setDescription(`ğŸ‰ **THáº®NG!** +${betAmount.toLocaleString('vi-VN')} VND\nğŸ’° Tá»•ng tiá»n: ${user.money.toLocaleString('vi-VN')} VND`);
    } else if (playerValue < dealerValue) {
      user.money -= betAmount;
      resultEmbed.setDescription(`ğŸ˜¢ **THUA!** -${betAmount.toLocaleString('vi-VN')} VND\nğŸ’° Tá»•ng tiá»n: ${user.money.toLocaleString('vi-VN')} VND`);
    } else {
      resultEmbed.setDescription(`ğŸ¤ **HÃ’A!** HoÃ n tiá»n\nğŸ’° Tá»•ng tiá»n: ${user.money.toLocaleString('vi-VN')} VND`);
    }

    userData[userId] = user;
    saveData();
    message.reply({ embeds: [resultEmbed] });
  }

  // XÃŒ DÃCH
  if (message.content.startsWith('!xidach') || message.content.startsWith('!blackjack')) {
    const commandNow = Date.now();
    const cooldownTime = 3000;
    if (commandCooldown.has(message.author.id)) {
      const lastUsed = commandCooldown.get(message.author.id);
      if (commandNow - lastUsed < cooldownTime) {
        return message.reply('Vui lÃ²ng chá» má»™t chÃºt trÆ°á»›c khi dÃ¹ng lá»‡nh nÃ y láº¡i.');
      }
    }
    commandCooldown.set(message.author.id, commandNow);

    const userId = message.author.id;
    const user = userData[userId] || { money: 0, isSearchingJob: false };

    const args = message.content.split(' ');
    let betAmount;

    if (args[1] === 'all') {
      betAmount = user.money;
    } else {
      betAmount = parseInt(args[1]);
    }

    if (!betAmount || betAmount <= 0) {
      return message.reply('CÃº phÃ¡p: `!xidach <sá»‘ tiá»n>` hoáº·c `!xidach all`\nVÃ­ dá»¥: `!xidach 10000`');
    }

    if (user.money < betAmount) {
      return message.reply(`Báº¡n khÃ´ng Ä‘á»§ tiá»n! Báº¡n chá»‰ cÃ³ ${user.money.toLocaleString('vi-VN')} VND.`);
    }

    const deck = shuffleDeck(createDeck());
    const playerHand = [drawCard(deck), drawCard(deck)];
    // RÃºt bÃ i cho nhÃ  cÃ¡i vá»›i logic má»›i
    const dealerFirstCard = drawCard(deck, true, true);
    const dealerSecondCard = drawCard(deck, true, false, dealerFirstCard);
    const dealerHand = [dealerFirstCard, dealerSecondCard];

    let playerValue = getHandValue(playerHand.map(c => c.slice(0, -1)));
    let dealerValue = getHandValue(dealerHand.map(c => c.slice(0, -1)));

    const gameEmbed = new EmbedBuilder()
      .setTitle('ğŸƒ XÃŒ DÃCH (BLACKJACK)')
      .setDescription(`ğŸ’° CÆ°á»£c: ${betAmount.toLocaleString('vi-VN')} VND`)
      .addFields(
        { name: 'ğŸ² BÃ i cá»§a báº¡n', value: `${playerHand.map(getCardDisplay).join(' ')} = **${playerValue}**`, inline: false },
        { name: 'ğŸ² BÃ i cá»§a nhÃ  cÃ¡i', value: `${getCardDisplay(dealerHand[0])} ğŸ´ = **?**`, inline: false },
        { name: 'â“', value: 'React: ğŸ‘ (Bá»‘c) | ğŸ‘ (Dá»«ng)', inline: false }
      )
      .setColor('#0099FF');

    const bjMsg = await message.reply({ embeds: [gameEmbed] });
    await bjMsg.react('ğŸ‘');
    await bjMsg.react('ğŸ‘');

    const bjFilter = (reaction, userReact) =>
      ['ğŸ‘', 'ğŸ‘'].includes(reaction.emoji.name) && userReact.id === userId;

    let playerBusted = false;
    let dealerBusted = false;

    const bjCollector = bjMsg.createReactionCollector({ filter: bjFilter, time: 60000 });

    bjCollector.on('collect', async (bjReaction) => {
      if (bjReaction.emoji.name === 'ğŸ‘') {
        playerHand.push(drawCard(deck));
        playerValue = getHandValue(playerHand.map(c => c.slice(0, -1)));

        if (playerValue > 21) {
          playerBusted = true;
          bjCollector.stop();
        } else {
          gameEmbed.spliceFields(0, 3, 
            { name: 'ğŸ² BÃ i cá»§a báº¡n', value: `${playerHand.map(getCardDisplay).join(' ')} = **${playerValue}**`, inline: false },
            { name: 'ğŸ² BÃ i cá»§a nhÃ  cÃ¡i', value: `${getCardDisplay(dealerHand[0])} ğŸ´ = **?**`, inline: false },
            { name: 'â“', value: 'React: ğŸ‘ (Bá»‘c) | ğŸ‘ (Dá»«ng)', inline: false }
          );
          await bjMsg.edit({ embeds: [gameEmbed] });
        }
      } else {
        bjCollector.stop();
      }
    });

    bjCollector.on('end', async () => {
      await bjMsg.reactions.removeAll().catch(() => {});

      while (dealerValue < 15 && !playerBusted) {
        dealerHand.push(drawCard(deck));
        dealerValue = getHandValue(dealerHand.map(c => c.slice(0, -1)));
        if (dealerValue > 21) {
          dealerBusted = true;
          break;
        }
      }

      const finalEmbed = new EmbedBuilder()
        .setTitle('ğŸƒ XÃŒ DÃCH - Káº¾T QUáº¢')
        .addFields(
          { name: 'ğŸ’° CÆ°á»£c', value: `${betAmount.toLocaleString('vi-VN')} VND`, inline: false },
          { name: 'ğŸ² BÃ i cá»§a báº¡n', value: `${playerHand.map(getCardDisplay).join(' ')} = **${playerValue}**`, inline: false },
          { name: 'ğŸ² BÃ i cá»§a nhÃ  cÃ¡i', value: `${dealerHand.map(getCardDisplay).join(' ')} = **${dealerValue}**`, inline: false }
        );

      if (playerBusted) {
        user.money -= betAmount;
        finalEmbed.setDescription(`ğŸ’¥ **QUáº®C!** Báº¡n vÆ°á»£t quÃ¡ 21!\nğŸ˜¢ **THUA!** -${betAmount.toLocaleString('vi-VN')} VND\nğŸ’° Tá»•ng tiá»n: ${user.money.toLocaleString('vi-VN')} VND`);
        finalEmbed.setColor('#FF0000');
      } else if (dealerBusted) {
        const winAmount = Math.floor(betAmount * 1.5);
        user.money += winAmount;
        finalEmbed.setDescription(`ğŸ’¥ NhÃ  cÃ¡i quáº¯c!\nğŸ‰ **THáº®NG!** +${winAmount.toLocaleString('vi-VN')} VND\nğŸ’° Tá»•ng tiá»n: ${user.money.toLocaleString('vi-VN')} VND`);
        finalEmbed.setColor('#00FF00');
      } else if (playerValue > dealerValue) {
        const winAmount = Math.floor(betAmount * 1.5);
        user.money += winAmount;
        finalEmbed.setDescription(`ğŸ‰ **THáº®NG!** +${winAmount.toLocaleString('vi-VN')} VND\nğŸ’° Tá»•ng tiá»n: ${user.money.toLocaleString('vi-VN')} VND`);
        finalEmbed.setColor('#00FF00');
      } else if (playerValue < dealerValue) {
        user.money -= betAmount;
        finalEmbed.setDescription(`ğŸ˜¢ **THUA!** -${betAmount.toLocaleString('vi-VN')} VND\nğŸ’° Tá»•ng tiá»n: ${user.money.toLocaleString('vi-VN')} VND`);
        finalEmbed.setColor('#FF0000');
      } else {
        finalEmbed.setDescription(`ğŸ¤ **HÃ’A!** HoÃ n tiá»n\nğŸ’° Tá»•ng tiá»n: ${user.money.toLocaleString('vi-VN')} VND`);
        finalEmbed.setColor('#FFFF00');
      }

      userData[userId] = user;
      saveData();
      message.reply({ embeds: [finalEmbed] });
    });
  }

  // FLIP COIN - Máº¶T NGá»¬A
  if (message.content.startsWith('!ngua')) {
    const commandNow = Date.now();
    const cooldownTime = 3000;
    if (commandCooldown.has(message.author.id)) {
      const lastUsed = commandCooldown.get(message.author.id);
      if (commandNow - lastUsed < cooldownTime) {
        return message.reply('Vui lÃ²ng chá» má»™t chÃºt trÆ°á»›c khi dÃ¹ng lá»‡nh nÃ y láº¡i.');
      }
    }
    commandCooldown.set(message.author.id, commandNow);

    const userId = message.author.id;
    const user = userData[userId] || { money: 0, isSearchingJob: false };

    const args = message.content.split(' ');
    let betAmount;

    if (args[1] === 'all') {
      betAmount = user.money;
    } else {
      betAmount = parseInt(args[1]);
    }

    if (!betAmount || betAmount <= 0) {
      return message.reply('CÃº phÃ¡p: `!ngua <sá»‘ tiá»n>` hoáº·c `!ngua all`\nVÃ­ dá»¥: `!ngua 10000`');
    }

    if (user.money < betAmount) {
      return message.reply(`Báº¡n khÃ´ng Ä‘á»§ tiá»n! Báº¡n chá»‰ cÃ³ ${user.money.toLocaleString('vi-VN')} VND.`);
    }

    const result = Math.random() < 0.40 ? 'ğŸ‘‘' : 'ğŸ¦…';  // Giáº£m tá»· lá»‡ tháº¯ng xuá»‘ng 40%
    const playerChoice = 'ğŸ‘‘';

    const resultEmbed = new EmbedBuilder()
      .setTitle('ğŸª™ TUNG XU - Máº¶T NGá»¬A')
      .addFields(
        { name: 'ğŸ’° CÆ°á»£c', value: `${betAmount.toLocaleString('vi-VN')} VND`, inline: false },
        { name: 'ğŸ¯ Báº¡n chá»n', value: 'Máº·t Ngá»­a ğŸ‘‘', inline: true },
        { name: 'ğŸ² Káº¿t quáº£', value: result === 'ğŸ‘‘' ? 'Máº·t Ngá»­a ğŸ‘‘' : 'Máº·t Sáº¥p ğŸ¦…', inline: true }
      );

    if (playerChoice === result) {
      user.money += betAmount;
      resultEmbed.setDescription(`ğŸ‰ **THáº®NG!** +${betAmount.toLocaleString('vi-VN')} VND\nğŸ’° Tá»•ng tiá»n: ${user.money.toLocaleString('vi-VN')} VND`);
      resultEmbed.setColor('#00FF00');
    } else {
      user.money -= betAmount;
      resultEmbed.setDescription(`ğŸ˜¢ **THUA!** -${betAmount.toLocaleString('vi-VN')} VND\nğŸ’° Tá»•ng tiá»n: ${user.money.toLocaleString('vi-VN')} VND`);
      resultEmbed.setColor('#FF0000');
    }

    userData[userId] = user;
    saveData();
    message.reply({ embeds: [resultEmbed] });
  }

  // FLIP COIN - Máº¶T Sáº¤P
  if (message.content.startsWith('!sap')) {
    const commandNow = Date.now();
    const cooldownTime = 3000;
    if (commandCooldown.has(message.author.id)) {
      const lastUsed = commandCooldown.get(message.author.id);
      if (commandNow - lastUsed < cooldownTime) {
        return message.reply('Vui lÃ²ng chá» má»™t chÃºt trÆ°á»›c khi dÃ¹ng lá»‡nh nÃ y láº¡i.');
      }
    }
    commandCooldown.set(message.author.id, commandNow);

    const userId = message.author.id;
    const user = userData[userId] || { money: 0, isSearchingJob: false };

    const args = message.content.split(' ');
    let betAmount;

    if (args[1] === 'all') {
      betAmount = user.money;
    } else {
      betAmount = parseInt(args[1]);
    }

    if (!betAmount || betAmount <= 0) {
      return message.reply('CÃº phÃ¡p: `!sap <sá»‘ tiá»n>` hoáº·c `!sap all`\nVÃ­ dá»¥: `!sap 10000`');
    }

    if (user.money < betAmount) {
      return message.reply(`Báº¡n khÃ´ng Ä‘á»§ tiá»n! Báº¡n chá»‰ cÃ³ ${user.money.toLocaleString('vi-VN')} VND.`);
    }

    const result = Math.random() < 0.5 ? 'ğŸ‘‘' : 'ğŸ¦…';
    const playerChoice = 'ğŸ¦…';

    const resultEmbed = new EmbedBuilder()
      .setTitle('ğŸª™ TUNG XU - Máº¶T Sáº¤P')
      .addFields(
        { name: 'ğŸ’° CÆ°á»£c', value: `${betAmount.toLocaleString('vi-VN')} VND`, inline: false },
        { name: 'ğŸ¯ Báº¡n chá»n', value: 'Máº·t Sáº¥p ğŸ¦…', inline: true },
        { name: 'ğŸ² Káº¿t quáº£', value: result === 'ğŸ‘‘' ? 'Máº·t Ngá»­a ğŸ‘‘' : 'Máº·t Sáº¥p ğŸ¦…', inline: true }
      );

    if (playerChoice === result) {
      user.money += betAmount;
      resultEmbed.setDescription(`ğŸ‰ **THáº®NG!** +${betAmount.toLocaleString('vi-VN')} VND\nğŸ’° Tá»•ng tiá»n: ${user.money.toLocaleString('vi-VN')} VND`);
      resultEmbed.setColor('#00FF00');
    } else {
      user.money -= betAmount;
      resultEmbed.setDescription(`ğŸ˜¢ **THUA!** -${betAmount.toLocaleString('vi-VN')} VND\nğŸ’° Tá»•ng tiá»n: ${user.money.toLocaleString('vi-VN')} VND`);
      resultEmbed.setColor('#FF0000');
    }

    userData[userId] = user;
    saveData();
    message.reply({ embeds: [resultEmbed] });
  }

  // SLOT MACHINE
  if (message.content.startsWith('!slot')) {
    const commandNow = Date.now();
    const cooldownTime = 3000;
    if (commandCooldown.has(message.author.id)) {
      const lastUsed = commandCooldown.get(message.author.id);
      if (commandNow - lastUsed < cooldownTime) {
        return message.reply('Vui lÃ²ng chá» má»™t chÃºt trÆ°á»›c khi dÃ¹ng lá»‡nh nÃ y láº¡i.');
      }
    }
    commandCooldown.set(message.author.id, commandNow);

    const userId = message.author.id;
    const user = userData[userId] || { money: 0, isSearchingJob: false };

    const args = message.content.split(' ');
    let betAmount;

    if (args[1] === 'all') {
      betAmount = user.money;
    } else {
      betAmount = parseInt(args[1]);
    }

    if (!betAmount || betAmount <= 0) {
      return message.reply('CÃº phÃ¡p: `!slot <sá»‘ tiá»n>` hoáº·c `!slot all`\nVÃ­ dá»¥: `!slot 10000`');
    }

    if (user.money < betAmount) {
      return message.reply(`Báº¡n khÃ´ng Ä‘á»§ tiá»n! Báº¡n chá»‰ cÃ³ ${user.money.toLocaleString('vi-VN')} VND.`);
    }

    const symbols = ['ğŸ’', 'ğŸ‹', 'ğŸŠ', 'ğŸ‡', 'ğŸ””', 'ğŸ’', '7ï¸âƒ£'];
    // Tá»‰ lá»‡ khÃ´ng thá»ƒ tháº¯ng cho ngÆ°á»i chÆ¡i thÆ°á»ng (Tá»•ng 100%):
    // ğŸ’: 75% - Thua cháº¯c cháº¯n, xuáº¥t hiá»‡n nhiá»u nháº¥t
    // ğŸ‹: 24.95% - Thua cháº¯c cháº¯n
    // ğŸŠ: 0.049% - Cá»±c ká»³ khÃ³ x2 (1/2000)
    // ğŸ‡: 0.0007% - Gáº§n nhÆ° khÃ´ng thá»ƒ x3 (1/142,857)
    // ğŸ””: 0.0002% - KhÃ´ng thá»ƒ x3 (1/500,000)
    // ğŸ’: 0.0001% - Báº¥t kháº£ thi x3 (1/1,000,000)
    // 7ï¸âƒ£: 0.00001% - Jackpot báº¥t kháº£ thi (1/10,000,000)
    const normalWeights = [75, 24.95, 0.049, 0.0007, 0.0002, 0.0001, 0.00001];  // Tá»‰ lá»‡ khÃ´ng thá»ƒ tháº¯ng

    // Tá»‰ lá»‡ Ä‘áº·c biá»‡t cho owner (Tá»•ng 100%):
    // ğŸ’: 0.1% - Gáº§n nhÆ° khÃ´ng thua
    // ğŸ‹: 0.1% - Gáº§n nhÆ° khÃ´ng thua
    // ğŸŠ: 8% - TÄƒng cÆ¡ há»™i x2
    // ğŸ‡: 5% - TÄƒng tá»‰ lá»‡ x3
    // ğŸ””: 4% - TÄƒng tá»‰ lá»‡ x3
    // ğŸ’: 2.8% - TÄƒng tá»‰ lá»‡ x3
    // 7ï¸âƒ£: 80% - Jackpot siÃªu dá»…
    const ownerWeights = [0.1, 0.1, 8, 5, 4, 2.8, 80];  // Tá»‰ lá»‡ tháº¯ng gáº§n nhÆ° tuyá»‡t Ä‘á»‘i cho owner

    function getRandomSymbol(isOwner = false, usedSymbols = []) {
      if (isOwner) {
        // Owner giá»¯ nguyÃªn logic cÅ© Ä‘á»ƒ dá»… tháº¯ng
        const weights = ownerWeights;
        const totalWeight = weights.reduce((a, b) => a + b, 0);
        let random = Math.random() * totalWeight;
        for (let i = 0; i < symbols.length; i++) {
          if (random < weights[i]) return symbols[i];
          random -= weights[i];
        }
        return symbols[0];
      } else {
        // NgÆ°á»i chÆ¡i thÆ°á»ng: 80% ra biá»ƒu tÆ°á»£ng khÃ¡c vá»›i 2 biá»ƒu tÆ°á»£ng trÆ°á»›c
        const weights = normalWeights;
        if (Math.random() < 0.8 && usedSymbols.length > 0) {
          // Láº¥y danh sÃ¡ch cÃ¡c biá»ƒu tÆ°á»£ng chÆ°a Ä‘Æ°á»£c dÃ¹ng
          const unusedSymbols = symbols.filter(s => !usedSymbols.includes(s));
          if (unusedSymbols.length > 0) {
            // TÃ­nh tá»•ng weight cá»§a cÃ¡c biá»ƒu tÆ°á»£ng chÆ°a dÃ¹ng
            const unusedWeights = unusedSymbols.map(s => weights[symbols.indexOf(s)]);
            const totalUnusedWeight = unusedWeights.reduce((a, b) => a + b, 0);
            let random = Math.random() * totalUnusedWeight;
            for (let i = 0; i < unusedSymbols.length; i++) {
              if (random < unusedWeights[i]) return unusedSymbols[i];
              random -= unusedWeights[i];
            }
            return unusedSymbols[0];
          }
        }
        // 20% cÃ²n láº¡i hoáº·c khi khÃ´ng cÃ²n biá»ƒu tÆ°á»£ng má»›i: dÃ¹ng logic cÅ©
        const totalWeight = weights.reduce((a, b) => a + b, 0);
        let random = Math.random() * totalWeight;
        for (let i = 0; i < symbols.length; i++) {
          if (random < weights[i]) return symbols[i];
          random -= weights[i];
        }
        return symbols[0];
      }
    }

    // Kiá»ƒm tra xem ngÆ°á»i chÆ¡i cÃ³ pháº£i lÃ  owner khÃ´ng
    const isOwner = message.author.id === ownerId;
    
    const usedSymbols = [];
    const slot1 = getRandomSymbol(isOwner, usedSymbols);
    usedSymbols.push(slot1);
    const slot2 = getRandomSymbol(isOwner, usedSymbols);
    usedSymbols.push(slot2);
    const slot3 = getRandomSymbol(isOwner, usedSymbols);

    const slotEmbed = new EmbedBuilder()
      .setTitle('ğŸ° SLOT MACHINE')
      .setDescription(`\`\`\`\n[ ${slot1} | ${slot2} | ${slot3} ]\n\`\`\``)
      .addFields({ name: 'ğŸ’° CÆ°á»£c', value: `${betAmount.toLocaleString('vi-VN')} VND`, inline: false })
      .setColor('#FF1493');

    let winMultiplier = 0;
    if (slot1 === slot2 && slot2 === slot3) {
      if (slot1 === '7ï¸âƒ£') winMultiplier = 20;
      else if (slot1 === 'ğŸ’') winMultiplier = 15;
      else if (slot1 === 'ğŸ””') winMultiplier = 10;
      else winMultiplier = 5;
    } else if (slot1 === slot2 || slot2 === slot3 || slot1 === slot3) {
      winMultiplier = 2;
    }

    if (winMultiplier > 0) {
      const winAmount = betAmount * winMultiplier;
      user.money += winAmount;
      slotEmbed.addFields({ name: 'ğŸ‰ Káº¿t quáº£', value: `**THáº®NG!** x${winMultiplier}\n+${winAmount.toLocaleString('vi-VN')} VND`, inline: false });
      slotEmbed.setColor('#00FF00');
    } else {
      user.money -= betAmount;
      slotEmbed.addFields({ name: 'ğŸ˜¢ Káº¿t quáº£', value: `**THUA!**\n-${betAmount.toLocaleString('vi-VN')} VND`, inline: false });
      slotEmbed.setColor('#FF0000');
    }

    slotEmbed.addFields({ name: 'ğŸ’° Tá»•ng tiá»n', value: `${user.money.toLocaleString('vi-VN')} VND`, inline: false });

    userData[userId] = user;
    saveData();
    message.reply({ embeds: [slotEmbed] });
  }

  // OWNER COMMANDS
  // Set Money
  if (message.content.startsWith('!setmoney')) {
    console.log(`Command user ID: ${message.author.id}, Owner ID: ${ownerId}, Match: ${message.author.id === ownerId}`);
    if (message.author.id !== ownerId) {
      return message.reply(`âŒ Chá»‰ owner má»›i cÃ³ thá»ƒ dÃ¹ng lá»‡nh nÃ y!\nYour ID: ${message.author.id}\nOwner ID: ${ownerId}`);
    }

    const args = message.content.split(' ');
    if (args.length < 3) {
      return message.reply('CÃº phÃ¡p: `!setmoney <@user hoáº·c userID> <sá»‘ tiá»n>`\nVÃ­ dá»¥: `!setmoney @user 1000000`');
    }

    const targetUserId = args[1].replace(/[<@!>]/g, '');
    const amount = parseInt(args[2]);

    if (!amount || amount < 0) {
      return message.reply('Sá»‘ tiá»n pháº£i lÃ  sá»‘ dÆ°Æ¡ng!');
    }

    const targetUser = userData[targetUserId] || { 
      lastCheckin: null, streak: 0, totalCheckins: 0, 
      money: 0, xp: 0, lastLevel: 1, inventory: [], 
      lastWork: null, selectedJob: null, attemptsToday: 0, isSearchingJob: false 
    };

    targetUser.money = amount;
    userData[targetUserId] = targetUser;
    saveData();

    message.reply(`âœ… ÄÃ£ set tiá»n cho <@${targetUserId}> thÃ nh ${amount.toLocaleString('vi-VN')} VND`);
  }

  // Add Money
  if (message.content.startsWith('!addmoney')) {
    if (message.author.id !== ownerId) {
      return message.reply('âŒ Chá»‰ owner má»›i cÃ³ thá»ƒ dÃ¹ng lá»‡nh nÃ y!');
    }

    const args = message.content.split(' ');
    if (args.length < 3) {
      return message.reply('CÃº phÃ¡p: `!addmoney <@user hoáº·c userID> <sá»‘ tiá»n>`\nVÃ­ dá»¥: `!addmoney @user 500000`');
    }

    const targetUserId = args[1].replace(/[<@!>]/g, '');
    const amount = parseInt(args[2]);

    if (!amount) {
      return message.reply('Sá»‘ tiá»n khÃ´ng há»£p lá»‡!');
    }

    const targetUser = userData[targetUserId] || { 
      lastCheckin: null, streak: 0, totalCheckins: 0, 
      money: 0, xp: 0, lastLevel: 1, inventory: [], 
      lastWork: null, selectedJob: null, attemptsToday: 0, isSearchingJob: false 
    };

    targetUser.money += amount;
    userData[targetUserId] = targetUser;
    saveData();

    message.reply(`âœ… ÄÃ£ ${amount >= 0 ? 'thÃªm' : 'trá»«'} ${Math.abs(amount).toLocaleString('vi-VN')} VND cho <@${targetUserId}>\nğŸ’° Tá»•ng tiá»n hiá»‡n táº¡i: ${targetUser.money.toLocaleString('vi-VN')} VND`);
  }

  // Set Level
  if (message.content.startsWith('!setlevel')) {
    if (message.author.id !== ownerId) {
      return message.reply('âŒ Chá»‰ owner má»›i cÃ³ thá»ƒ dÃ¹ng lá»‡nh nÃ y!');
    }

    const args = message.content.split(' ');
    if (args.length < 3) {
      return message.reply('CÃº phÃ¡p: `!setlevel <@user hoáº·c userID> <level>`\nVÃ­ dá»¥: `!setlevel @user 50`');
    }

    const targetUserId = args[1].replace(/[<@!>]/g, '');
    const level = parseInt(args[2]);

    if (!level || level < 1 || level > 1000) {
      return message.reply('Level pháº£i tá»« 1 Ä‘áº¿n 1000!');
    }

    const targetUser = userData[targetUserId] || { 
      lastCheckin: null, streak: 0, totalCheckins: 0, 
      money: 0, xp: 0, lastLevel: 1, inventory: [], 
      lastWork: null, selectedJob: null, attemptsToday: 0, isSearchingJob: false 
    };

    // Calculate XP needed for target level
    let requiredXP = 0;
    for (let i = 1; i < level; i++) {
      requiredXP += i * 100 + (i - 1) * 50;
    }

    targetUser.xp = requiredXP;
    targetUser.lastLevel = level;
    userData[targetUserId] = targetUser;
    saveData();

    message.reply(`âœ… ÄÃ£ set level cho <@${targetUserId}> thÃ nh ${level}\nğŸ“Š XP hiá»‡n táº¡i: ${requiredXP}`);
  }

  // Add XP
  if (message.content.startsWith('!addxp')) {
    if (message.author.id !== ownerId) {
      return message.reply('âŒ Chá»‰ owner má»›i cÃ³ thá»ƒ dÃ¹ng lá»‡nh nÃ y!');
    }

    const args = message.content.split(' ');
    if (args.length < 3) {
      return message.reply('CÃº phÃ¡p: `!addxp <@user hoáº·c userID> <xp>`\nVÃ­ dá»¥: `!addxp @user 1000`');
    }

    const targetUserId = args[1].replace(/[<@!>]/g, '');
    const xp = parseInt(args[2]);

    if (!xp) {
      return message.reply('XP khÃ´ng há»£p lá»‡!');
    }

    const targetUser = userData[targetUserId] || { 
      lastCheckin: null, streak: 0, totalCheckins: 0, 
      money: 0, xp: 0, lastLevel: 1, inventory: [], 
      lastWork: null, selectedJob: null, attemptsToday: 0, isSearchingJob: false 
    };

    targetUser.xp += xp;
    if (targetUser.xp < 0) targetUser.xp = 0;

    const { level } = getLevelInfo(targetUser.xp);
    targetUser.lastLevel = level;

    userData[targetUserId] = targetUser;
    saveData();

    message.reply(`âœ… ÄÃ£ ${xp >= 0 ? 'thÃªm' : 'trá»«'} ${Math.abs(xp)} XP cho <@${targetUserId}>\nğŸ“Š XP hiá»‡n táº¡i: ${targetUser.xp}\nğŸ† Level hiá»‡n táº¡i: ${level}`);
  }

  // Give Item
  if (message.content.startsWith('!giveitem')) {
    if (message.author.id !== ownerId) {
      return message.reply('âŒ Chá»‰ owner má»›i cÃ³ thá»ƒ dÃ¹ng lá»‡nh nÃ y!');
    }

    const args = message.content.split(' ');
    if (args.length < 3) {
      return message.reply('CÃº phÃ¡p: `!giveitem <@user hoáº·c userID> <sá»‘ lÆ°á»£ng>`\nVÃ­ dá»¥: `!giveitem @user 5`');
    }

    const targetUserId = args[1].replace(/[<@!>]/g, '');
    const count = parseInt(args[2]) || 1;

    if (count < 1 || count > 50) {
      return message.reply('Sá»‘ lÆ°á»£ng pháº£i tá»« 1 Ä‘áº¿n 50!');
    }

    const targetUser = userData[targetUserId] || { 
      lastCheckin: null, streak: 0, totalCheckins: 0, 
      money: 0, xp: 0, lastLevel: 1, inventory: [], 
      lastWork: null, selectedJob: null, attemptsToday: 0, isSearchingJob: false 
    };

    targetUser.inventory = targetUser.inventory || [];
    const receivedItems = [];

    for (let i = 0; i < count; i++) {
      const item = getRandomItem();
      targetUser.inventory.push(item);
      receivedItems.push(item.name);
    }

    userData[targetUserId] = targetUser;
    saveData();

    const itemList = receivedItems.join(', ');
    message.reply(`âœ… ÄÃ£ táº·ng ${count} item cho <@${targetUserId}>:\nğŸ ${itemList}`);
  }

  // Set Job
  if (message.content.startsWith('!setjob')) {
    if (message.author.id !== ownerId) {
      return message.reply('âŒ Chá»‰ owner má»›i cÃ³ thá»ƒ dÃ¹ng lá»‡nh nÃ y!');
    }

    const args = message.content.split(' ');
    if (args.length < 3) {
      const jobList = jobs.map((j, i) => `${i + 1}. ${j.name}`).join('\n');
      return message.reply(`CÃº phÃ¡p: \`!setjob <@user hoáº·c userID> <tÃªn job>\`\n\n**Danh sÃ¡ch job:**\n${jobList}\n\nVÃ­ dá»¥: \`!setjob @user Coder\``);
    }

    const targetUserId = args[1].replace(/[<@!>]/g, '');
    const jobName = args.slice(2).join(' ');

    const job = jobs.find(j => j.name.toLowerCase() === jobName.toLowerCase());
    if (!job) {
      const jobList = jobs.map(j => j.name).join(', ');
      return message.reply(`âŒ Job khÃ´ng tá»“n táº¡i!\n\n**Danh sÃ¡ch job:** ${jobList}`);
    }

    const targetUser = userData[targetUserId] || { 
      lastCheckin: null, streak: 0, totalCheckins: 0, 
      money: 0, xp: 0, lastLevel: 1, inventory: [], 
      lastWork: null, selectedJob: null, attemptsToday: 0, isSearchingJob: false 
    };

    targetUser.selectedJob = job.name;
    targetUser.attemptsToday = 0;
    targetUser.lastWork = null;
    userData[targetUserId] = targetUser;
    saveData();

    message.reply(`âœ… ÄÃ£ set job cho <@${targetUserId}> thÃ nh **${job.name}**\nğŸ’° LÆ°Æ¡ng: ${job.payPerHour.toLocaleString('vi-VN')} VND/giá»`);
  }

  // Give Money to All
  if (message.content.startsWith('!givemoneyall')) {
    if (message.author.id !== ownerId) {
      return message.reply('âŒ Chá»‰ owner má»›i cÃ³ thá»ƒ dÃ¹ng lá»‡nh nÃ y!');
    }

    const args = message.content.split(' ');
    const amount = parseInt(args[1]);

    if (!amount || amount <= 0) {
      return message.reply('CÃº phÃ¡p: `!givemoneyall <sá»‘ tiá»n>`\nVÃ­ dá»¥: `!givemoneyall 100000`');
    }

    let count = 0;
    for (let userId in userData) {
      userData[userId].money += amount;
      count++;
    }

    saveData();
    message.reply(`âœ… ÄÃ£ táº·ng ${amount.toLocaleString('vi-VN')} VND cho táº¥t cáº£ ${count} ngÆ°á»i chÆ¡i!`);
  }

  // View User Data
  if (message.content.startsWith('!userdata')) {
    if (message.author.id !== ownerId) {
      return message.reply('âŒ Chá»‰ owner má»›i cÃ³ thá»ƒ dÃ¹ng lá»‡nh nÃ y!');
    }

    const args = message.content.split(' ');
    if (args.length < 2) {
      return message.reply('CÃº phÃ¡p: `!userdata <@user hoáº·c userID>`\nVÃ­ dá»¥: `!userdata @user`');
    }

    const targetUserId = args[1].replace(/[<@!>]/g, '');
    const targetUser = userData[targetUserId];

    if (!targetUser) {
      return message.reply('âŒ User chÆ°a cÃ³ data!');
    }

    const { level } = getLevelInfo(targetUser.xp);
    
    const embed = new EmbedBuilder()
      .setTitle(`ğŸ“Š Data cá»§a User ${targetUserId}`)
      .setColor('#0099FF')
      .addFields(
        { name: 'ğŸ’° Tiá»n', value: `${targetUser.money.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ“Š XP', value: `${targetUser.xp}`, inline: true },
        { name: 'ğŸ† Level', value: `${level}`, inline: true },
        { name: 'ğŸ”¥ Streak', value: `${targetUser.streak || 0} ngÃ y`, inline: true },
        { name: 'ğŸ“… Tá»•ng check-in', value: `${targetUser.totalCheckins || 0}`, inline: true },
        { name: 'ğŸ’¼ Nghá» nghiá»‡p', value: targetUser.selectedJob || 'ChÆ°a chá»n', inline: true },
        { name: 'ğŸ’ Sá»‘ item', value: `${targetUser.inventory?.length || 0}`, inline: true },
        { name: 'ğŸ” isSearchingJob', value: `${targetUser.isSearchingJob ? 'CÃ³' : 'KhÃ´ng'}`, inline: true },
        { name: 'ğŸ¯ Láº§n thá»­ viá»‡c hÃ´m nay', value: `${targetUser.attemptsToday || 0}/3`, inline: true }
      );

    message.reply({ embeds: [embed] });
  }

  // Set Streak
  if (message.content.startsWith('!setstreak')) {
    if (message.author.id !== ownerId) {
      return message.reply('âŒ Chá»‰ owner má»›i cÃ³ thá»ƒ dÃ¹ng lá»‡nh nÃ y!');
    }

    const args = message.content.split(' ');
    if (args.length < 3) {
      return message.reply('CÃº phÃ¡p: `!setstreak <@user hoáº·c userID> <sá»‘ ngÃ y>`\nVÃ­ dá»¥: `!setstreak @user 7`');
    }

    const targetUserId = args[1].replace(/[<@!>]/g, '');
    const streak = parseInt(args[2]);

    if (!streak || streak < 0) {
      return message.reply('Sá»‘ ngÃ y streak pháº£i lÃ  sá»‘ dÆ°Æ¡ng!');
    }

    const targetUser = userData[targetUserId] || { 
      lastCheckin: null, streak: 0, totalCheckins: 0, 
      money: 0, xp: 0, lastLevel: 1, inventory: [], 
      lastWork: null, selectedJob: null, attemptsToday: 0, isSearchingJob: false 
    };

    targetUser.streak = streak;
    userData[targetUserId] = targetUser;
    saveData();

    message.reply(`âœ… ÄÃ£ set streak cho <@${targetUserId}> thÃ nh ${streak} ngÃ y`);
  }

  // Reset All Data
  if (message.content === '!resetalldata') {
    if (message.author.id !== ownerId) {
      return message.reply('âŒ Chá»‰ owner má»›i cÃ³ thá»ƒ dÃ¹ng lá»‡nh nÃ y!');
    }

    const confirmEmbed = new EmbedBuilder()
      .setTitle('âš ï¸ Cáº¢NH BÃO: XÃ“A Táº¤T Cáº¢ Dá»® LIá»†U')
      .setDescription('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a toÃ n bá»™ dá»¯ liá»‡u cá»§a táº¥t cáº£ ngÆ°á»i chÆ¡i?\nReact âœ… Ä‘á»ƒ xÃ¡c nháº­n hoáº·c âŒ Ä‘á»ƒ há»§y.')
      .setColor('#FF0000');

    const confirmMsg = await message.reply({ embeds: [confirmEmbed] });
    await confirmMsg.react('âœ…');
    await confirmMsg.react('âŒ');

    const filter = (reaction, user) => 
      ['âœ…', 'âŒ'].includes(reaction.emoji.name) && user.id === message.author.id;

    const collector = confirmMsg.createReactionCollector({ filter, time: 30000 });

    collector.on('collect', async (reaction) => {
      if (reaction.emoji.name === 'âœ…') {
        userData = {};
        saveData();
        profileProcessing.clear();
        lastMessageTime.clear();
        commandCooldown.clear();
        await confirmMsg.reactions.removeAll();
        message.reply('âœ… ÄÃ£ xÃ³a toÃ n bá»™ dá»¯ liá»‡u thÃ nh cÃ´ng!');
      } else {
        await confirmMsg.reactions.removeAll();
        message.reply('âŒ ÄÃ£ há»§y lá»‡nh xÃ³a dá»¯ liá»‡u.');
      }
      collector.stop();
    });

    collector.on('end', async (collected, reason) => {
      if (reason === 'time') {
        await confirmMsg.reactions.removeAll();
        message.reply('âŒ Háº¿t thá»i gian xÃ¡c nháº­n, lá»‡nh Ä‘Ã£ bá»‹ há»§y.');
      }
    });
  }

  // Top Richest Players
  if (message.content === '!toprich') {
    const topPlayers = Object.entries(userData)
      .sort(([,a], [,b]) => b.money - a.money)
      .slice(0, 10);

    if (topPlayers.length === 0) {
      return message.reply('ChÆ°a cÃ³ dá»¯ liá»‡u ngÆ°á»i chÆ¡i!');
    }

    let desc = '';
    for (let i = 0; i < topPlayers.length; i++) {
      const [userId, user] = topPlayers[i];
      desc += `${i + 1}. <@${userId}> - ${user.money.toLocaleString('vi-VN')} VND\n`;
    }

    const embed = new EmbedBuilder()
      .setTitle('ğŸ’° TOP 10 NGÆ¯á»œI GIÃ€U NHáº¤T')
      .setDescription(desc)
      .setColor('#FFD700')
      .setFooter({ text: 'Cáº­p nháº­t theo thá»i gian thá»±c' });

    message.reply({ embeds: [embed] });
  }

  // Top Level Players
  if (message.content === '!toplevel') {
    const topPlayers = Object.entries(userData)
      .map(([id, user]) => ({
        id,
        level: getLevelInfo(user.xp).level,
        xp: user.xp
      }))
      .sort((a, b) => b.level - a.level || b.xp - a.xp)
      .slice(0, 10);

    if (topPlayers.length === 0) {
      return message.reply('ChÆ°a cÃ³ dá»¯ liá»‡u ngÆ°á»i chÆ¡i!');
    }

    let desc = '';
    for (let i = 0; i < topPlayers.length; i++) {
      const player = topPlayers[i];
      desc += `${i + 1}. <@${player.id}> - Level ${player.level} (${player.xp} XP)\n`;
    }

    const embed = new EmbedBuilder()
      .setTitle('ğŸ† TOP 10 LEVEL CAO NHáº¤T')
      .setDescription(desc)
      .setColor('#FF69B4')
      .setFooter({ text: 'Cáº­p nháº­t theo thá»i gian thá»±c' });

    message.reply({ embeds: [embed] });
  }

  // Find Rich Players
  if (message.content.startsWith('!findrich')) {
    if (message.author.id !== ownerId) {
      return message.reply('âŒ Chá»‰ owner má»›i cÃ³ thá»ƒ dÃ¹ng lá»‡nh nÃ y!');
    }

    const args = message.content.split(' ');
    const minMoney = parseInt(args[1]) || 1000000; // Máº·c Ä‘á»‹nh 1 triá»‡u

    const richPlayers = Object.entries(userData)
      .filter(([,user]) => user.money >= minMoney)
      .sort(([,a], [,b]) => b.money - a.money);

    if (richPlayers.length === 0) {
      return message.reply(`KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i chÆ¡i cÃ³ tá»« ${minMoney.toLocaleString('vi-VN')} VND trá»Ÿ lÃªn!`);
    }

    let desc = `**Danh sÃ¡ch ngÆ°á»i chÆ¡i cÃ³ tá»« ${minMoney.toLocaleString('vi-VN')} VND trá»Ÿ lÃªn:**\n\n`;
    for (const [userId, user] of richPlayers) {
      desc += `<@${userId}> - ${user.money.toLocaleString('vi-VN')} VND\n`;
    }

    const embed = new EmbedBuilder()
      .setTitle('ğŸ” TÃŒM NGÆ¯á»œI CHÆ I GIÃ€U')
      .setDescription(desc)
      .setColor('#4169E1')
      .setFooter({ text: `TÃ¬m tháº¥y ${richPlayers.length} ngÆ°á»i chÆ¡i` });

    message.reply({ embeds: [embed] });
  }

  // Shop commands
  if (message.content === '!shop') {
    const embed = new EmbedBuilder()
      .setTitle('ğŸª SHOP')
      .setDescription('Chá»n danh má»¥c báº¡n muá»‘n xem:')
      .addFields(
        { 
          name: 'ğŸ“œ DANH Má»¤C', 
          value: 'ğŸ‘• `!shop fashion` - Cá»­a hÃ ng thá»i trang\nğŸ± `!shop pets` - Cá»­a hÃ ng thÃº cÆ°ng\nğŸš— `!shop vehicles` - Cá»­a hÃ ng phÆ°Æ¡ng tiá»‡n', 
          inline: false 
        },
        {
          name: 'ğŸ›ï¸ CÃCH MUA HÃ€NG',
          value: 'Sá»­ dá»¥ng lá»‡nh `!buy <itemID>` Ä‘á»ƒ mua váº­t pháº©m\nVÃ­ dá»¥: `!buy F1`, `!buy P1`, `!buy V1`',
          inline: false
        }
      )
      .setColor('#FF69B4')
      .setFooter({ text: 'Sá»­ dá»¥ng !inventory Ä‘á»ƒ xem tÃºi Ä‘á»“ cá»§a báº¡n' });

    message.reply({ embeds: [embed] });
    return;
  }

  if (message.content.startsWith('!shop ')) {
    const category = message.content.split(' ')[1];
    if (!['fashion', 'pets', 'vehicles'].includes(category)) {
      return message.reply('Danh má»¥c khÃ´ng há»£p lá»‡! Sá»­ dá»¥ng `!shop` Ä‘á»ƒ xem danh sÃ¡ch danh má»¥c.');
    }

    const itemsList = getShopItemsList(category, false);
    const categoryTitles = {
      fashion: 'ğŸ‘• Cá»¬A HÃ€NG THá»œI TRANG',
      pets: 'ğŸ± Cá»¬A HÃ€NG THÃš CÆ¯NG',
      vehicles: 'ğŸš— Cá»¬A HÃ€NG PHÆ¯Æ NG TIá»†N'
    };

    const embed = new EmbedBuilder()
      .setTitle(categoryTitles[category])
      .setDescription(itemsList)
      .setColor('#FF69B4')
      .setFooter({ text: 'Sá»­ dá»¥ng !buy <itemID> Ä‘á»ƒ mua váº­t pháº©m' });

    message.reply({ embeds: [embed] });
    return;
  }

  // Banking Commands
  if (message.content === '!bank' || message.content === '!banking') {
    const userId = message.author.id;
    const user = userData[userId] || { 
      lastCheckin: null, streak: 0, totalCheckins: 0, 
      money: 0, xp: 0, lastLevel: 1, inventory: [], 
      lastWork: null, selectedJob: null, attemptsToday: 0, 
      isSearchingJob: false 
    };

    if (!user.banking) createBankingProfile(userId);

    const embed = new EmbedBuilder()
      .setTitle('ğŸ¦ NGÃ‚N HÃ€NG')
      .addFields(
        { name: 'ğŸ’° Sá»‘ dÆ° tÃ i khoáº£n', value: `${user.banking.balance.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ’µ Tiá»n máº·t', value: `${user.money.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ“… NgÃ y má»Ÿ TK', value: new Date(user.banking.createdAt).toLocaleDateString('vi-VN'), inline: true },
        { name: 'ğŸ“ DANH SÃCH Lá»†NH', value: 
          '`!deposit <sá»‘ tiá»n>` - Náº¡p tiá»n vÃ o tÃ i khoáº£n\n' +
          '`!withdraw <sá»‘ tiá»n>` - RÃºt tiá»n tá»« tÃ i khoáº£n\n' +
          '`!transfer <@user> <sá»‘ tiá»n> [ghi chÃº]` - Chuyá»ƒn tiá»n cho ngÆ°á»i khÃ¡c\n' +
          '`!history` - Xem lá»‹ch sá»­ giao dá»‹ch', inline: false }
      )
      .setColor('#00FF00');

    message.reply({ embeds: [embed] });
    return;
  }

  if (message.content.startsWith('!deposit ')) {
    const userId = message.author.id;
    const user = userData[userId] || { 
      lastCheckin: null, streak: 0, totalCheckins: 0, 
      money: 0, xp: 0, lastLevel: 1, inventory: [], 
      lastWork: null, selectedJob: null, attemptsToday: 0, 
      isSearchingJob: false 
    };

    if (!user.banking) createBankingProfile(userId);

    let amount;
    const amountArg = message.content.split(' ')[1];
    
    if (amountArg.toLowerCase() === 'all') {
      amount = user.money;
    } else {
      amount = parseInt(amountArg);
    }

    if (!amount || amount <= 0) {
      return message.reply('âŒ Sá»‘ tiá»n khÃ´ng há»£p lá»‡!\nSá»­ dá»¥ng `!deposit all` Ä‘á»ƒ náº¡p toÃ n bá»™ tiá»n máº·t.');
    }

    if (user.money < amount) {
      return message.reply('âŒ Báº¡n khÃ´ng Ä‘á»§ tiá»n máº·t Ä‘á»ƒ náº¡p!');
    }

    user.money -= amount;
    user.banking.balance += amount;
    addTransaction(userId, 'deposit', amount, 'Náº¡p tiá»n vÃ o tÃ i khoáº£n');
    saveData();

    const embed = new EmbedBuilder()
      .setTitle('ğŸ“¥ Náº P TIá»€N THÃ€NH CÃ”NG')
      .addFields(
        { name: 'ğŸ’° Sá»‘ tiá»n náº¡p', value: `${amount.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ’³ Sá»‘ dÆ° má»›i', value: `${user.banking.balance.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ’µ Tiá»n máº·t cÃ²n láº¡i', value: `${user.money.toLocaleString('vi-VN')} VND`, inline: true }
      )
      .setColor('#00FF00');

    message.reply({ embeds: [embed] });
    return;
  }

  if (message.content.startsWith('!withdraw ')) {
    const userId = message.author.id;
    const user = userData[userId] || { 
      lastCheckin: null, streak: 0, totalCheckins: 0, 
      money: 0, xp: 0, lastLevel: 1, inventory: [], 
      lastWork: null, selectedJob: null, attemptsToday: 0, 
      isSearchingJob: false 
    };

    if (!user.banking) createBankingProfile(userId);

    let amount;
    const amountArg = message.content.split(' ')[1];
    
    if (amountArg.toLowerCase() === 'all') {
      amount = user.banking.balance;
    } else {
      amount = parseInt(amountArg);
    }

    if (!amount || amount <= 0) {
      return message.reply('âŒ Sá»‘ tiá»n khÃ´ng há»£p lá»‡!\nSá»­ dá»¥ng `!withdraw all` Ä‘á»ƒ rÃºt toÃ n bá»™ sá»‘ dÆ°.');
    }

    if (user.banking.balance < amount) {
      return message.reply('âŒ Sá»‘ dÆ° tÃ i khoáº£n khÃ´ng Ä‘á»§!');
    }

    user.banking.balance -= amount;
    user.money += amount;
    addTransaction(userId, 'withdraw', amount, 'RÃºt tiá»n tá»« tÃ i khoáº£n');
    saveData();

    const embed = new EmbedBuilder()
      .setTitle('ğŸ“¤ RÃšT TIá»€N THÃ€NH CÃ”NG')
      .addFields(
        { name: 'ğŸ’° Sá»‘ tiá»n rÃºt', value: `${amount.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ’³ Sá»‘ dÆ° cÃ²n láº¡i', value: `${user.banking.balance.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ’µ Tiá»n máº·t hiá»‡n cÃ³', value: `${user.money.toLocaleString('vi-VN')} VND`, inline: true }
      )
      .setColor('#00FF00');

    message.reply({ embeds: [embed] });
    return;
  }

  if (message.content.startsWith('!transfer ')) {
    const userId = message.author.id;
    const user = userData[userId] || { 
      lastCheckin: null, streak: 0, totalCheckins: 0, 
      money: 0, xp: 0, lastLevel: 1, inventory: [], 
      lastWork: null, selectedJob: null, attemptsToday: 0, 
      isSearchingJob: false 
    };

    if (!user.banking) createBankingProfile(userId);

    const args = message.content.split(' ');
    if (args.length < 3) {
      return message.reply('âŒ CÃº phÃ¡p: `!transfer <@user> <sá»‘ tiá»n> [ghi chÃº]`');
    }

    const targetId = args[1].replace(/[<@!>]/g, '');
    if (targetId === userId) {
      return message.reply('âŒ Báº¡n khÃ´ng thá»ƒ chuyá»ƒn tiá»n cho chÃ­nh mÃ¬nh!');
    }

    let amount;
    if (args[2].toLowerCase() === 'all') {
      amount = user.banking.balance;
      if (amount <= 0) {
        return message.reply('âŒ Sá»‘ dÆ° tÃ i khoáº£n cá»§a báº¡n lÃ  0 VND!');
      }
    } else {
      amount = parseInt(args[2]);
      if (isNaN(amount)) {
        return message.reply('âŒ Sá»‘ tiá»n khÃ´ng há»£p lá»‡!\nğŸ’¡ VÃ­ dá»¥: `!transfer <@user> 100000` hoáº·c `!transfer <@user> all`');
      }
    }

    if (amount < 1) {
      return message.reply('âŒ Sá»‘ tiá»n chuyá»ƒn pháº£i lá»›n hÆ¡n 0 VND!');
    }

    if (user.banking.balance < amount) {
      return message.reply(`âŒ Sá»‘ dÆ° tÃ i khoáº£n khÃ´ng Ä‘á»§!\nğŸ’° Sá»‘ dÆ° hiá»‡n táº¡i: ${user.banking.balance.toLocaleString('vi-VN')} VND`);
    }

    const targetUser = userData[targetId];
    if (!targetUser) {
      return message.reply('âŒ KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i nháº­n!');
    }

    if (!targetUser.banking) createBankingProfile(targetId);

    const note = args.slice(3).join(' ') || 'KhÃ´ng cÃ³ ghi chÃº';

    // Thá»±c hiá»‡n chuyá»ƒn tiá»n
    user.banking.balance -= amount;
    targetUser.banking.balance += amount;

    // Ghi transaction cho cáº£ 2 bÃªn
    addTransaction(userId, 'transfer_out', amount, note, targetId);
    addTransaction(targetId, 'transfer_in', amount, note, userId);
    
    saveData();

    const embed = new EmbedBuilder()
      .setTitle('ğŸ’¸ CHUYá»‚N TIá»€N THÃ€NH CÃ”NG')
      .addFields(
        { name: 'ğŸ‘¥ NgÆ°á»i nháº­n', value: `<@${targetId}>`, inline: true },
        { name: 'ğŸ’° Sá»‘ tiá»n', value: `${amount.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ’³ Sá»‘ dÆ° cÃ²n láº¡i', value: `${user.banking.balance.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ’¬ Ghi chÃº', value: note, inline: false }
      )
      .setColor('#00FF00');

    message.reply({ embeds: [embed] });

    // Gá»­i thÃ´ng bÃ¡o cho ngÆ°á»i nháº­n
    const notifyEmbed = new EmbedBuilder()
      .setTitle('ğŸ’° NHáº¬N TIá»€N THÃ€NH CÃ”NG')
      .addFields(
        { name: 'ğŸ‘¤ NgÆ°á»i gá»­i', value: `<@${userId}>`, inline: true },
        { name: 'ğŸ’° Sá»‘ tiá»n', value: `${amount.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ’³ Sá»‘ dÆ° má»›i', value: `${targetUser.banking.balance.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ’¬ Ghi chÃº', value: note, inline: false }
      )
      .setColor('#00FF00');

    const targetMember = message.guild.members.cache.get(targetId);
    if (targetMember) {
      targetMember.send({ embeds: [notifyEmbed] }).catch(() => {
        // Náº¿u khÃ´ng gá»­i Ä‘Æ°á»£c DM, gá»­i vÃ o kÃªnh hiá»‡n táº¡i
        message.channel.send({ content: `<@${targetId}>`, embeds: [notifyEmbed] });
      });
    }

    return;
  }

  if (message.content === '!history') {
    const userId = message.author.id;
    const user = userData[userId] || { 
      lastCheckin: null, streak: 0, totalCheckins: 0, 
      money: 0, xp: 0, lastLevel: 1, inventory: [], 
      lastWork: null, selectedJob: null, attemptsToday: 0, 
      isSearchingJob: false 
    };

    if (!user.banking) createBankingProfile(userId);

    const history = formatTransactionHistory(user.banking.transactions, userData);
    
    const embed = new EmbedBuilder()
      .setTitle('ğŸ“œ Lá»ŠCH Sá»¬ GIAO Dá»ŠCH')
      .setDescription(history)
      .addFields(
        { name: 'ğŸ’³ Sá»‘ dÆ° hiá»‡n táº¡i', value: `${user.banking.balance.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ’µ Tiá»n máº·t', value: `${user.money.toLocaleString('vi-VN')} VND`, inline: true }
      )
      .setColor('#4169E1')
      .setFooter({ text: 'Hiá»ƒn thá»‹ 10 giao dá»‹ch gáº§n nháº¥t' });

    message.reply({ embeds: [embed] });
    return;
  }

  if (message.content.startsWith('!buy ')) {
    const itemId = message.content.split(' ')[1].toUpperCase();
    const userId = message.author.id;
    const user = userData[userId] || { 
      lastCheckin: null, streak: 0, totalCheckins: 0, 
      money: 0, xp: 0, lastLevel: 1, inventory: [], 
      lastWork: null, selectedJob: null, attemptsToday: 0, 
      isSearchingJob: false 
    };

    const item = findItemById(itemId);
    if (!item) {
      return message.reply('âŒ MÃ£ váº­t pháº©m khÃ´ng há»£p lá»‡!');
    }

    if (item.type !== 'shop') {
      return message.reply('âŒ Váº­t pháº©m nÃ y khÃ´ng bÃ¡n trong shop!');
    }

    const price = item.price;
    if (user.money < price) {
      return message.reply(`âŒ Báº¡n khÃ´ng Ä‘á»§ tiá»n! Báº¡n cáº§n thÃªm ${(price - user.money).toLocaleString('vi-VN')} VND ná»¯a.`);
    }

    // ThÃªm thÃ´ng tin bá»• sung khi mua
    const purchasedItem = {
      ...item,
      purchaseDate: new Date().toISOString(),
      canSell: true
    };

    user.money -= price;
    user.inventory = user.inventory || [];
    user.inventory.push(purchasedItem);
    userData[userId] = user;
    saveData();

    let desc = `âœ… ÄÃ£ mua thÃ nh cÃ´ng: **${item.name}**\nğŸ’° GiÃ¡: ${price.toLocaleString('vi-VN')} VND\nğŸ’µ Sá»‘ dÆ° cÃ²n láº¡i: ${user.money.toLocaleString('vi-VN')} VND`;
    
    if (item.category === 'pets') {
      desc += `\n\nğŸ¾ ThÃ´ng tin thÃº cÆ°ng:\nLoáº¡i: ${item.type}\nThá»©c Äƒn: ${item.food}`;
    } else if (item.category === 'vehicles') {
      desc += `\n\nğŸš— ThÃ´ng tin phÆ°Æ¡ng tiá»‡n:\nLoáº¡i: ${item.type}\nNhiÃªn liá»‡u: ${item.fuel}`;
    }

    const embed = new EmbedBuilder()
      .setTitle('ğŸ›ï¸ MUA HÃ€NG THÃ€NH CÃ”NG')
      .setDescription(desc)
      .setColor('#00FF00');

    message.reply({ embeds: [embed] });
    return;
  }

  // Server Stats
  if (message.content === '!serverstats') {
    if (message.author.id !== ownerId) {
      return message.reply('âŒ Chá»‰ owner má»›i cÃ³ thá»ƒ dÃ¹ng lá»‡nh nÃ y!');
    }

    const totalPlayers = Object.keys(userData).length;
    const totalMoney = Object.values(userData).reduce((sum, user) => sum + user.money, 0);
    const avgMoney = totalPlayers > 0 ? Math.floor(totalMoney / totalPlayers) : 0;
    
    const totalXP = Object.values(userData).reduce((sum, user) => sum + user.xp, 0);
    const avgXP = totalPlayers > 0 ? Math.floor(totalXP / totalPlayers) : 0;

    const activeJobs = Object.values(userData)
      .filter(user => user.selectedJob)
      .reduce((acc, user) => {
        acc[user.selectedJob] = (acc[user.selectedJob] || 0) + 1;
        return acc;
      }, {});

    let jobStats = '';
    for (const [job, count] of Object.entries(activeJobs)) {
      jobStats += `${job}: ${count} ngÆ°á»i\n`;
    }

    const embed = new EmbedBuilder()
      .setTitle('ğŸ“Š THá»NG KÃŠ SERVER')
      .addFields(
        { name: 'ğŸ‘¥ Tá»•ng ngÆ°á»i chÆ¡i', value: totalPlayers.toString(), inline: true },
        { name: 'ğŸ’° Tá»•ng tiá»n', value: `${totalMoney.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ’µ Tiá»n trung bÃ¬nh', value: `${avgMoney.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ“ˆ Tá»•ng XP', value: totalXP.toString(), inline: true },
        { name: 'ğŸ“Š XP trung bÃ¬nh', value: avgXP.toString(), inline: true },
        { name: '\u200B', value: '\u200B', inline: true },
        { name: 'ğŸ’¼ Thá»‘ng kÃª nghá» nghiá»‡p', value: jobStats || 'KhÃ´ng cÃ³ dá»¯ liá»‡u', inline: false }
      )
      .setColor('#32CD32')
      .setFooter({ text: 'Cáº­p nháº­t theo thá»i gian thá»±c' });

    message.reply({ embeds: [embed] });
  }

  // List all items
  if (message.content === '!listitems' || message.content === '!itemslist') {
    const isOwner = message.author.id === ownerId;
    const itemsList = getAllItemsList(isOwner);
    
    const embed = new EmbedBuilder()
      .setTitle('ğŸ“¦ DANH SÃCH Váº¬T PHáº¨M')
      .setDescription(itemsList)
      .addFields(
        { 
          name: 'ğŸ¯ Äá»™ Hiáº¿m', 
          value: 'âšª ThÆ°á»ng (40%)\nğŸŸ¢ Phá»¥ kiá»‡n (30%)\nğŸ”µ Hiáº¿m (20%)\nğŸŸ£ Cá»±c Hiáº¿m (9.99%)\nğŸŸ¡ SiÃªu Hiáº¿m (0.0099%)\nğŸ”´ Tháº§n Thoáº¡i (0.0001%)', 
          inline: false 
        }
      )
      .setColor('#4169E1');

    if (isOwner) {
      embed.setFooter({ text: '[OWNER] Báº¡n Ä‘ang xem danh sÃ¡ch Ä‘áº§y Ä‘á»§ vá»›i ID vÃ  giÃ¡ trá»‹' });
    } else {
      embed.setFooter({ text: 'Nháº­n váº­t pháº©m thÃ´ng qua: LÃªn level, Check-in, Event' });
    }

    message.reply({ embeds: [embed] });
  }

  // Give item by ID
  if (message.content.startsWith('!giveitemid')) {
    if (message.author.id !== ownerId) {
      return message.reply('âŒ Chá»‰ owner má»›i cÃ³ thá»ƒ dÃ¹ng lá»‡nh nÃ y!');
    }

    const args = message.content.split(' ');
    if (args.length < 3) {
      return message.reply('CÃº phÃ¡p: `!giveitemid <@user hoáº·c userID> <itemID> [sá»‘ lÆ°á»£ng]`\nVÃ­ dá»¥: `!giveitemid @user SSUR1 1`\nDÃ¹ng `!listitems` Ä‘á»ƒ xem danh sÃ¡ch ID');
    }

    const targetUserId = args[1].replace(/[<@!>]/g, '');
    const itemId = args[2].toUpperCase();
    const quantity = parseInt(args[3]) || 1;

    if (quantity < 1 || quantity > 50) {
      return message.reply('Sá»‘ lÆ°á»£ng pháº£i tá»« 1 Ä‘áº¿n 50!');
    }

    const item = findItemById(itemId);
    if (!item) {
      return message.reply('âŒ KhÃ´ng tÃ¬m tháº¥y item vá»›i ID nÃ y! DÃ¹ng `!listitems` Ä‘á»ƒ xem danh sÃ¡ch ID');
    }

    const targetUser = userData[targetUserId] || { 
      lastCheckin: null, streak: 0, totalCheckins: 0, 
      money: 0, xp: 0, lastLevel: 1, inventory: [], 
      lastWork: null, selectedJob: null, attemptsToday: 0, isSearchingJob: false 
    };

    targetUser.inventory = targetUser.inventory || [];
    
    for (let i = 0; i < quantity; i++) {
      targetUser.inventory.push(item);
    }

    userData[targetUserId] = targetUser;
    saveData();

    const embed = new EmbedBuilder()
      .setTitle('ğŸ Táº¶NG Váº¬T PHáº¨M')
      .setDescription(`ÄÃ£ táº·ng cho <@${targetUserId}>:`)
      .addFields(
        { name: 'ğŸ“¦ Váº­t pháº©m', value: `${item.name} (${item.id})`, inline: true },
        { name: 'ğŸ“Š Sá»‘ lÆ°á»£ng', value: quantity.toString(), inline: true },
        { name: 'ğŸ’° GiÃ¡ trá»‹', value: `${item.sellPrice.toLocaleString('vi-VN')} VND`, inline: true },
        { name: 'ğŸ¯ Äá»™ hiáº¿m', value: item.rarity.toUpperCase(), inline: true }
      )
      .setColor('#FF69B4');

    message.reply({ embeds: [embed] });
  }

  // End of message handler
  });
});

client.login(token);