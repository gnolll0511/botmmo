const { EmbedBuilder } = require('discord.js');

// Utility functions
function createDeck() {
  const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
  const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
  const deck = [];
  for (let suit of suits) {
    for (let value of values) {
      deck.push(value + suit);
    }
  }
  return deck;
}

function shuffleDeck(deck) {
  // Bias the shuffle to favor dealer wins
  const originalDeck = [...deck];
  const biasedDeck = [];
  
  // First, try to put good cards for dealer at top
  const goodCards = originalDeck.filter(card => ['A', 'K', 'Q', 'J', '10'].includes(card[0]));
  const normalCards = originalDeck.filter(card => !['A', 'K', 'Q', 'J', '10'].includes(card[0]));
  
  // 60% chance to put good cards near the top for dealer
  if (Math.random() < 0.6) {
    biasedDeck.push(...goodCards.splice(0, 4));
    while (goodCards.length > 0 || normalCards.length > 0) {
      if (normalCards.length > 0) {
        const idx = Math.floor(Math.random() * normalCards.length);
        biasedDeck.push(normalCards.splice(idx, 1)[0]);
      }
      if (goodCards.length > 0) {
        const idx = Math.floor(Math.random() * goodCards.length);
        biasedDeck.push(goodCards.splice(idx, 1)[0]);
      }
    }
  } else {
    // Regular shuffle for 40% of games
    for (let i = deck.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [deck[i], deck[j]] = [deck[j], deck[i]];
    }
    return deck;
  }
  
  return biasedDeck;
}

function getCardValue(card) {
  if (card === 'A') return 11;
  if (['J', 'Q', 'K'].includes(card)) return 10;
  return parseInt(card);
}

function getHandValue(hand) {
  let value = 0;
  let aces = 0;
  for (let card of hand) {
    if (card === 'A') {
      aces++;
      value += 11;
    } else if (['J', 'Q', 'K'].includes(card)) {
      value += 10;
    } else {
      value += parseInt(card);
    }
  }
  while (value > 21 && aces > 0) {
    value -= 10;
    aces--;
  }
  return value;
}

function drawCard(deck, isDealer = false) {
  // Give dealer advantage by increasing chance of good cards
  if (isDealer && Math.random() < 0.6) {
    // Look for face cards or 10s first
    const goodCard = deck.findIndex(card => ['10', 'J', 'Q', 'K', 'A'].includes(card[0]));
    if (goodCard !== -1) {
      return deck.splice(goodCard, 1)[0];
    }
  }
  return deck.pop();
}

function getCardDisplay(card) {
  return `\`${card}\``;
}

// Casino command handlers
async function handleBaCay(message, betAmount, userData, saveData) {
  const deck = shuffleDeck(createDeck());
  
  // Give dealer 60% chance of better cards
  const dealerAdvantage = Math.random() < 0.6;
  const playerCards = [drawCard(deck), drawCard(deck), drawCard(deck)];
  const dealerCards = [
    drawCard(deck, dealerAdvantage),
    drawCard(deck, dealerAdvantage),
    drawCard(deck, dealerAdvantage)
  ];

  const playerValue = (getCardValue(playerCards[0].slice(0, -1)) + 
                      getCardValue(playerCards[1].slice(0, -1)) + 
                      getCardValue(playerCards[2].slice(0, -1))) % 10;
  const dealerValue = (getCardValue(dealerCards[0].slice(0, -1)) + 
                      getCardValue(dealerCards[1].slice(0, -1)) + 
                      getCardValue(dealerCards[2].slice(0, -1))) % 10;
  
  function checkRoyalCards(cards) {
    return cards.filter(card => ['J', 'Q', 'K'].includes(card.slice(0, -1))).length === 3;
  }
  
  const playerHasRoyal = checkRoyalCards(playerCards);
  const dealerHasRoyal = checkRoyalCards(dealerCards);

  const resultEmbed = new EmbedBuilder()
    .setTitle('ðŸŽ´ BA CÃ‚Y')
    .addFields(
      { name: 'ðŸŽ² BÃ i cá»§a báº¡n', value: `${playerCards.map(getCardDisplay).join(' ')} = **${playerValue}**${playerHasRoyal ? ' (Ba GiÃ !)' : ''}`, inline: true },
      { name: 'ðŸŽ² BÃ i nhÃ  cÃ¡i', value: `${dealerCards.map(getCardDisplay).join(' ')} = **${dealerValue}**${dealerHasRoyal ? ' (Ba GiÃ !)' : ''}`, inline: true }
    );

  const user = userData;
  if (playerHasRoyal && !dealerHasRoyal) {
    user.money += betAmount * 2;
    resultEmbed.setDescription(`ðŸŽ‰ **THáº®NG X2!** +${(betAmount * 2).toLocaleString('vi-VN')}`);
    resultEmbed.setColor('#00FF00');
  } else if (dealerHasRoyal && !playerHasRoyal) {
    user.money -= betAmount;
    resultEmbed.setDescription(`ðŸ˜¢ **THUA!** -${betAmount.toLocaleString('vi-VN')}`);
    resultEmbed.setColor('#FF0000');
  } else if (playerHasRoyal && dealerHasRoyal) {
    resultEmbed.setDescription('ðŸ¤ **HÃ’A!** HoÃ n tiá»n');
    resultEmbed.setColor('#FFFF00');
  } else if (playerValue > dealerValue) {
    user.money += betAmount;
    resultEmbed.setDescription(`ðŸŽ‰ **THáº®NG!** +${betAmount.toLocaleString('vi-VN')}`);
    resultEmbed.setColor('#00FF00');
  } else if (playerValue < dealerValue) {
    user.money -= betAmount;
    resultEmbed.setDescription(`ðŸ˜¢ **THUA!** -${betAmount.toLocaleString('vi-VN')}`);
    resultEmbed.setColor('#FF0000');
  } else {
    resultEmbed.setDescription('ðŸ¤ **HÃ’A!** HoÃ n tiá»n');
    resultEmbed.setColor('#FFFF00');
  }

  resultEmbed.addFields({ name: 'ðŸ’° Sá»‘ dÆ°', value: user.money.toLocaleString('vi-VN'), inline: true });
  saveData();
  return message.reply({ embeds: [resultEmbed] });
}

async function handleBlackjack(message, betAmount, userData, saveData) {
  const deck = shuffleDeck(createDeck());
  
  // Give dealer 60% chance of better starting hand
  const dealerAdvantage = Math.random() < 0.6;
  const playerHand = [drawCard(deck), drawCard(deck)];
  const dealerHand = [drawCard(deck, dealerAdvantage), drawCard(deck, dealerAdvantage)];

  let playerValue = getHandValue(playerHand.map(c => c.slice(0, -1)));
  let dealerValue = getHandValue(dealerHand.map(c => c.slice(0, -1)));

  const gameEmbed = new EmbedBuilder()
    .setTitle('ðŸƒ XÃŒ DÃCH')
    .addFields(
      { name: 'ðŸŽ² BÃ i cá»§a báº¡n', value: `${playerHand.map(getCardDisplay).join(' ')} = **${playerValue}**`, inline: true },
      { name: 'ðŸŽ² BÃ i nhÃ  cÃ¡i', value: `${getCardDisplay(dealerHand[0])} ðŸŽ´`, inline: true },
      { name: 'â“', value: 'ðŸ‘ RÃºt thÃªm | ðŸ‘Ž Dá»«ng láº¡i', inline: true }
    )
    .setColor('#0099FF');

  const bjMsg = await message.reply({ embeds: [gameEmbed] });
  await bjMsg.react('ðŸ‘');
  await bjMsg.react('ðŸ‘Ž');

  const filter = (reaction, user) => ['ðŸ‘', 'ðŸ‘Ž'].includes(reaction.emoji.name) && user.id === message.author.id;
  const collector = bjMsg.createReactionCollector({ filter, time: 30000 });

  let playerBusted = false;
  collector.on('collect', async (reaction) => {
    if (reaction.emoji.name === 'ðŸ‘') {
      playerHand.push(drawCard(deck));
      playerValue = getHandValue(playerHand.map(c => c.slice(0, -1)));
      if (playerValue > 21) {
        playerBusted = true;
        collector.stop();
      } else {
        gameEmbed.spliceFields(0, 3,
          { name: 'ðŸŽ² BÃ i cá»§a báº¡n', value: `${playerHand.map(getCardDisplay).join(' ')} = **${playerValue}**`, inline: true },
          { name: 'ðŸŽ² BÃ i nhÃ  cÃ¡i', value: `${getCardDisplay(dealerHand[0])} ðŸŽ´`, inline: true },
          { name: 'â“', value: 'ðŸ‘ RÃºt thÃªm | ðŸ‘Ž Dá»«ng láº¡i', inline: true }
        );
        await bjMsg.edit({ embeds: [gameEmbed] });
      }
    } else {
      collector.stop();
    }
  });

  collector.on('end', async () => {
    await bjMsg.reactions.removeAll();

    // Dealer draws with advantage
    while (dealerValue < 16 && !playerBusted) {
      dealerHand.push(drawCard(deck, dealerAdvantage));
      dealerValue = getHandValue(dealerHand.map(c => c.slice(0, -1)));
    }

    const resultEmbed = new EmbedBuilder()
      .setTitle('ðŸƒ XÃŒ DÃCH')
      .addFields(
        { name: 'ðŸŽ² BÃ i cá»§a báº¡n', value: `${playerHand.map(getCardDisplay).join(' ')} = **${playerValue}**`, inline: true },
        { name: 'ðŸŽ² BÃ i nhÃ  cÃ¡i', value: `${dealerHand.map(getCardDisplay).join(' ')} = **${dealerValue}**`, inline: true }
      );

    const user = userData;
    if (playerBusted) {
      user.money -= betAmount;
      resultEmbed.setDescription(`ðŸ’¥ **QUáº®C!** -${betAmount.toLocaleString('vi-VN')}`);
      resultEmbed.setColor('#FF0000');
    } else if (dealerValue > 21) {
      const winAmount = Math.floor(betAmount * 1.5);
      user.money += winAmount;
      resultEmbed.setDescription(`ðŸŽ‰ **THáº®NG!** +${winAmount.toLocaleString('vi-VN')}`);
      resultEmbed.setColor('#00FF00');
    } else if (playerValue > dealerValue) {
      const winAmount = Math.floor(betAmount * 1.5);
      user.money += winAmount;
      resultEmbed.setDescription(`ðŸŽ‰ **THáº®NG!** +${winAmount.toLocaleString('vi-VN')}`);
      resultEmbed.setColor('#00FF00');
    } else if (playerValue < dealerValue) {
      user.money -= betAmount;
      resultEmbed.setDescription(`ðŸ˜¢ **THUA!** -${betAmount.toLocaleString('vi-VN')}`);
      resultEmbed.setColor('#FF0000');
    } else {
      resultEmbed.setDescription('ðŸ¤ **HÃ’A!** HoÃ n tiá»n');
      resultEmbed.setColor('#FFFF00');
    }

    resultEmbed.addFields({ name: 'ðŸ’° Sá»‘ dÆ°', value: user.money.toLocaleString('vi-VN'), inline: true });
    saveData();
    message.reply({ embeds: [resultEmbed] });
  });
}

function handleCoinFlip(message, betAmount, choice, userData, saveData) {
  // Adjust probability to give house 60% advantage
  const houseEdge = 0.6;
  const result = Math.random() < (choice === 'ðŸ‘‘' ? (1 - houseEdge) : (1 - houseEdge)) ? 'ðŸ‘‘' : 'ðŸ¦…';
  
  const resultEmbed = new EmbedBuilder()
    .setTitle('ðŸª™ TUNG XU')
    .addFields(
      { name: 'ðŸŽ¯ Báº¡n chá»n', value: choice === 'ðŸ‘‘' ? 'Máº·t Ngá»­a ðŸ‘‘' : 'Máº·t Sáº¥p ðŸ¦…', inline: true },
      { name: 'ðŸŽ² Káº¿t quáº£', value: result === 'ðŸ‘‘' ? 'Máº·t Ngá»­a ðŸ‘‘' : 'Máº·t Sáº¥p ðŸ¦…', inline: true }
    );

  const user = userData;
  if (choice === result) {
    user.money += betAmount;
    resultEmbed.setDescription(`ðŸŽ‰ **THáº®NG!** +${betAmount.toLocaleString('vi-VN')}`);
    resultEmbed.setColor('#00FF00');
  } else {
    user.money -= betAmount;
    resultEmbed.setDescription(`ðŸ˜¢ **THUA!** -${betAmount.toLocaleString('vi-VN')}`);
    resultEmbed.setColor('#FF0000');
  }

  resultEmbed.addFields({ name: 'ðŸ’° Sá»‘ dÆ°', value: user.money.toLocaleString('vi-VN'), inline: true });
  saveData();
  return message.reply({ embeds: [resultEmbed] });
}

function handleSlot(message, betAmount, userData, saveData, isOwner) {
  const symbols = ['ðŸ’', 'ðŸ‹', 'ðŸŠ', 'ðŸ‡', 'ðŸ””', 'ðŸ’Ž', '7ï¸âƒ£'];
  
  // Adjusted weights for 40% win rate:
  const normalWeights = [
    35,    // ðŸ’ - Common, no win
    25,    // ðŸ‹ - Common, no win
    20,    // ðŸŠ - Common, x2 for pairs
    12,    // ðŸ‡ - Uncommon, x2 for pairs
    5,     // ðŸ”” - Rare, x3 for three
    2,     // ðŸ’Ž - Very rare, x5 for three
    1      // 7ï¸âƒ£ - Jackpot, x10 for three
  ];
  
  // Owner weights unchanged
  const ownerWeights = [0.1, 0.1, 8, 5, 4, 2.8, 80];
  
  const weights = isOwner ? ownerWeights : normalWeights;

  function getRandomSymbol(usedSymbols = []) {
    // Ensure house edge by making it harder to match symbols
    if (!isOwner && Math.random() < 0.6) {
      // 60% chance to pick a different symbol than previous
      const availableSymbols = symbols.filter(s => !usedSymbols.includes(s));
      if (availableSymbols.length > 0) {
        const idx = Math.floor(Math.random() * availableSymbols.length);
        return availableSymbols[idx];
      }
    }
    
    // Normal weighted random selection
    const totalWeight = weights.reduce((a, b) => a + b, 0);
    let random = Math.random() * totalWeight;
    for (let i = 0; i < symbols.length; i++) {
      if (random < weights[i]) return symbols[i];
      random -= weights[i];
    }
    return symbols[0];
  }

  const usedSymbols = [];
  const slot1 = getRandomSymbol(usedSymbols);
  usedSymbols.push(slot1);
  const slot2 = getRandomSymbol(usedSymbols);
  usedSymbols.push(slot2);
  const slot3 = getRandomSymbol(usedSymbols);

  const slotEmbed = new EmbedBuilder()
    .setTitle('ðŸŽ° SLOT')
    .setDescription(`\n[ ${slot1} ${slot2} ${slot3} ]\n`);

  const user = userData;
  let winMultiplier = 0;
  if (slot1 === slot2 && slot2 === slot3) {
    if (slot1 === '7ï¸âƒ£') winMultiplier = 10;
    else if (slot1 === 'ðŸ’Ž') winMultiplier = 5;
    else if (slot1 === 'ðŸ””') winMultiplier = 3;
    else winMultiplier = 2;
  } else if (slot1 === slot2 || slot2 === slot3 || slot1 === slot3) {
    winMultiplier = 2;
  }

  if (winMultiplier > 0) {
    const winAmount = betAmount * winMultiplier;
    user.money += winAmount;
    slotEmbed.setDescription(`\n[ ${slot1} ${slot2} ${slot3} ]\nðŸŽ‰ **THáº®NG X${winMultiplier}!** +${winAmount.toLocaleString('vi-VN')}`);
    slotEmbed.setColor('#00FF00');
  } else {
    user.money -= betAmount;
    slotEmbed.setDescription(`\n[ ${slot1} ${slot2} ${slot3} ]\nðŸ˜¢ **THUA!** -${betAmount.toLocaleString('vi-VN')}`);
    slotEmbed.setColor('#FF0000');
  }

  slotEmbed.addFields({ name: 'ðŸ’° Sá»‘ dÆ°', value: user.money.toLocaleString('vi-VN'), inline: true });
  saveData();
  return message.reply({ embeds: [slotEmbed] });
}

module.exports = {
  handleBaCay,
  handleBlackjack,
  handleCoinFlip,
  handleSlot
};